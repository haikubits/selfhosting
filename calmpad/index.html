<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calm Notepad</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    screens: {
                        'xs': '400px', // Extra small breakpoint
                    }
                }
            }
        }
    </script>

    <!-- 3. Load Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <style>
        /* Hide scrollbar for Chrome/Safari/Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Custom Scrollbar for desktop hover */
        @media (min-width: 768px) {
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.1);
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: rgba(0,0,0,0.2);
            }
            .dark ::-webkit-scrollbar-thumb {
                background: rgba(255,255,255,0.1);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN REACT APPLICATION -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Search, Settings, Download, Upload, 
            Trash2, History, Sidebar, Type, 
            Moon, Sun, Coffee, Eye, EyeOff, FileText, 
            X, Save, RotateCcw, Menu
        } from 'lucide-react';

        const ID = () => '_' + Math.random().toString(36).substr(2, 9);

        // Theme Configurations
        const THEMES = {
            light: {
                bg: 'bg-white',
                text: 'text-stone-800',
                sidebar: 'bg-stone-50 border-r border-stone-200',
                itemActive: 'bg-white shadow-sm border border-stone-200',
                itemHover: 'hover:bg-stone-100',
                accent: 'text-stone-900',
                muted: 'text-stone-400',
                input: 'bg-transparent',
                border: 'border-stone-200'
            },
            sepia: {
                bg: 'bg-[#F4ECD8]',
                text: 'text-[#433422]',
                sidebar: 'bg-[#EAE0C9] border-r border-[#D3C4A5]',
                itemActive: 'bg-[#F4ECD8] shadow-sm border border-[#D3C4A5]',
                itemHover: 'hover:bg-[#E4D9C0]',
                accent: 'text-[#5C4B37]',
                muted: 'text-[#9C8B74]',
                input: 'bg-transparent',
                border: 'border-[#D3C4A5]'
            },
            dim: {
                bg: 'bg-slate-800',
                text: 'text-slate-300',
                sidebar: 'bg-slate-900 border-r border-slate-700',
                itemActive: 'bg-slate-800 border border-slate-600',
                itemHover: 'hover:bg-slate-800',
                accent: 'text-slate-100',
                muted: 'text-slate-500',
                input: 'bg-slate-900',
                border: 'border-slate-700'
            },
            dark: {
                bg: 'bg-black',
                text: 'text-neutral-400',
                sidebar: 'bg-neutral-900 border-r border-neutral-800',
                itemActive: 'bg-black border border-neutral-700',
                itemHover: 'hover:bg-neutral-800',
                accent: 'text-neutral-200',
                muted: 'text-neutral-600',
                input: 'bg-neutral-900',
                border: 'border-neutral-800'
            }
        };

        const SimpleMarkdown = ({ content, themeClass }) => {
            if (!content) return <div className="opacity-50 italic mt-4">Empty note...</div>;
            const lines = content.split('\n');
            return (
                <div className={`prose max-w-none pb-20 ${themeClass === 'dark' || themeClass === 'dim' ? 'prose-invert' : ''}`}>
                    {lines.map((line, i) => {
                        if (line.startsWith('# ')) return <h1 key={i} className="text-2xl md:text-3xl font-bold mb-4 mt-2">{line.slice(2)}</h1>;
                        if (line.startsWith('## ')) return <h2 key={i} className="text-xl md:text-2xl font-bold mb-3 mt-6">{line.slice(3)}</h2>;
                        if (line.startsWith('### ')) return <h3 key={i} className="text-lg md:text-xl font-bold mb-2 mt-4">{line.slice(4)}</h3>;
                        if (line.startsWith('> ')) return <blockquote key={i} className="pl-4 border-l-4 border-current italic my-2 opacity-80">{line.slice(2)}</blockquote>;
                        if (line.startsWith('- ') || line.startsWith('* ')) return <li key={i} className="ml-4 list-disc mb-1">{line.slice(2)}</li>;
                        if (line === '---' || line === '***') return <hr key={i} className="my-6 border-current opacity-30"/>;
                        
                        const __html = line
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                            .replace(/\*(.*?)\*/g, '<i>$1</i>')
                            .replace(/`(.*?)`/g, '<code class="bg-gray-500 bg-opacity-20 rounded px-1 text-sm">$1</code>');
                        
                        return <p key={i} className="mb-2 min-h-[1rem] leading-relaxed" dangerouslySetInnerHTML={{ __html: __html || '&nbsp;' }} />;
                    })}
                </div>
            );
        };

        function App() {
            // Data State
            const [notes, setNotes] = useState([]);
            const [activeNoteId, setActiveNoteId] = useState(null);
            
            // UI State
            const [searchQuery, setSearchQuery] = useState('');
            const [theme, setTheme] = useState('light');
            const [font, setFont] = useState('serif');
            const [showSidebar, setShowSidebar] = useState(true); // Default open on desktop
            const [focusMode, setFocusMode] = useState(false);
            const [isPreview, setIsPreview] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            
            const editorRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const saveTimeoutRef = useRef(null);

            // Responsive Init: Check if mobile, close sidebar by default
            useEffect(() => {
                if (window.innerWidth < 768) {
                    setShowSidebar(false);
                }
            }, []);

            // Load Data
            useEffect(() => {
                const savedData = localStorage.getItem('calm_notepad_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        setNotes(parsed.notes || []);
                        setActiveNoteId(parsed.activeNoteId || null);
                        setTheme(parsed.preferences?.theme || 'light');
                        setFont(parsed.preferences?.font || 'serif');
                    } catch (e) { console.error(e); }
                } else {
                    const welcomeId = ID();
                    const welcomeNote = {
                        id: welcomeId,
                        title: 'Welcome',
                        content: `# Calm Notepad\n\nA minimalist, distraction-free writing app.\n\n- Mobile friendly\n- Offline only\n- Markdown support`,
                        updatedAt: Date.now(),
                        versions: []
                    };
                    setNotes([welcomeNote]);
                    setActiveNoteId(welcomeId);
                }
            }, []);

            // Auto Save
            useEffect(() => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                saveTimeoutRef.current = setTimeout(() => {
                    const data = { notes, activeNoteId, preferences: { theme, font } };
                    localStorage.setItem('calm_notepad_data', JSON.stringify(data));
                }, 1000);
                return () => clearTimeout(saveTimeoutRef.current);
            }, [notes, activeNoteId, theme, font]);

            // CRUD Operations
            const createNote = () => {
                const newNote = { id: ID(), title: '', content: '', updatedAt: Date.now(), versions: [] };
                setNotes([newNote, ...notes]);
                setActiveNoteId(newNote.id);
                // On mobile, close sidebar after creating
                if (window.innerWidth < 768) setShowSidebar(false);
                setTimeout(() => editorRef.current?.focus(), 100);
            };

            const deleteNote = (id) => {
                if (confirm('Delete this note?')) {
                    const newNotes = notes.filter(n => n.id !== id);
                    setNotes(newNotes);
                    if (activeNoteId === id) setActiveNoteId(newNotes[0]?.id || null);
                }
            };

            const updateNote = (id, text) => {
                setNotes(prev => prev.map(n => {
                    if (n.id !== id) return n;
                    const lines = text.split('\n');
                    const title = lines[0].replace(/#+\s*/, '').substring(0, 40) || 'Untitled';
                    
                    // Simple versioning: if > 5 mins or first edit
                    let versions = n.versions || [];
                    const now = Date.now();
                    const lastTime = versions.length > 0 ? versions[versions.length - 1].time : 0;
                    if (now - lastTime > 300000 && n.content !== text) {
                         versions = [...versions, { content: n.content, time: now }].slice(-10);
                    }

                    return { ...n, content: text, title, versions, updatedAt: now };
                }));
                
                setIsTyping(true);
                if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);
                typingTimeoutRef.current = setTimeout(() => setIsTyping(false), 1500);
            };

            // Helpers
            const getActiveNote = () => notes.find(n => n.id === activeNoteId);
            const filteredNotes = notes.filter(n => 
                (n.title || '').toLowerCase().includes(searchQuery.toLowerCase()) || 
                (n.content || '').toLowerCase().includes(searchQuery.toLowerCase())
            ).sort((a, b) => b.updatedAt - a.updatedAt);

            const themeStyles = THEMES[theme];
            const activeNote = getActiveNote();
            const wordCount = activeNote ? activeNote.content.split(/\s+/).filter(w => w.length).length : 0;

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    try {
                        const json = JSON.parse(text);
                        if (json.notes) {
                            setNotes([...json.notes, ...notes]);
                            return;
                        }
                    } catch {}
                    const newNote = { id: ID(), title: file.name, content: text, updatedAt: Date.now(), versions: [] };
                    setNotes([newNote, ...notes]);
                    setActiveNoteId(newNote.id);
                };
                reader.readAsText(file);
            };

            const exportAll = () => {
                const blob = new Blob([JSON.stringify({ notes, preferences: { theme, font } })], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            return (
                <div className={`flex h-screen w-full overflow-hidden relative transition-colors duration-300 ${themeStyles.bg} ${themeStyles.text} ${font === 'serif' ? 'font-serif' : 'font-sans'}`}>
                    
                    {/* OVERLAY FOR MOBILE SIDEBAR */}
                    {showSidebar && (
                        <div 
                            className="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm"
                            onClick={() => setShowSidebar(false)}
                        ></div>
                    )}

                    {/* SIDEBAR */}
                    <div className={`
                        fixed inset-y-0 left-0 z-40 w-full xs:w-80 md:relative md:w-80 md:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none border-r ${themeStyles.sidebar}
                        ${showSidebar ? 'translate-x-0' : '-translate-x-full'}
                        flex flex-col
                    `}>
                        <div className="p-4 space-y-4">
                            <div className="flex items-center justify-between">
                                <h1 className={`font-bold text-lg tracking-tight ${themeStyles.accent}`}>Calm Notes</h1>
                                <div className="flex gap-2">
                                    <button onClick={createNote} className="p-2 rounded-full hover:bg-black/5 transition-colors"><Plus size={20} /></button>
                                    <button onClick={() => setShowSidebar(false)} className="p-2 rounded-full hover:bg-black/5 md:hidden"><X size={20} /></button>
                                </div>
                            </div>
                            <div className={`flex items-center px-3 py-2 rounded-md ${themeStyles.input} border ${themeStyles.border}`}>
                                <Search size={16} className={themeStyles.muted} />
                                <input 
                                    type="text" 
                                    placeholder="Search..." 
                                    className={`ml-2 w-full bg-transparent outline-none text-base placeholder-opacity-50 ${themeStyles.muted}`}
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 pb-2">
                            {filteredNotes.map(note => (
                                <div 
                                    key={note.id}
                                    onClick={() => { setActiveNoteId(note.id); if(window.innerWidth < 768) setShowSidebar(false); }}
                                    className={`p-4 mb-2 rounded-lg cursor-pointer transition-all ${activeNoteId === note.id ? themeStyles.itemActive : `bg-transparent ${themeStyles.itemHover}`}`}
                                >
                                    <div className="flex justify-between items-start">
                                        <h3 className={`font-medium text-base truncate pr-2 ${activeNoteId === note.id ? themeStyles.accent : ''}`}>{note.title || 'Untitled'}</h3>
                                        {activeNoteId === note.id && (
                                            <button onClick={(e) => { e.stopPropagation(); deleteNote(note.id); }} className="text-red-400 hover:text-red-600">
                                                <Trash2 size={14} />
                                            </button>
                                        )}
                                    </div>
                                    <p className="text-sm truncate mt-1 opacity-70 h-5">{note.content.substring(0, 50).replace(/[\n#]/g, ' ')}</p>
                                    <div className="text-xs mt-2 opacity-40">{new Date(note.updatedAt).toLocaleDateString()}</div>
                                </div>
                            ))}
                        </div>
                        
                        <div className={`p-4 border-t ${themeStyles.border} flex justify-between items-center text-xs opacity-60`}>
                            <button onClick={exportAll} className="flex items-center gap-1 hover:underline"><Download size={14} /> Backup</button>
                            <label className="flex items-center gap-1 cursor-pointer hover:underline">
                                <Upload size={14} /> Import
                                <input type="file" className="hidden" onChange={handleFileUpload} />
                            </label>
                        </div>
                    </div>

                    {/* MAIN AREA */}
                    <div className="flex-1 flex flex-col h-full relative w-full">
                        
                        {/* TOOLBAR (Scrollable on mobile) */}
                        <div className={`
                            h-14 min-h-[3.5rem] flex items-center justify-between px-3 md:px-8 border-b ${themeStyles.border}
                            transition-all duration-300
                            ${focusMode && isTyping ? 'opacity-0' : 'opacity-100'}
                        `}>
                            <div className="flex items-center gap-3 shrink-0">
                                <button onClick={() => setShowSidebar(!showSidebar)} className={`p-2 rounded hover:bg-black/5 ${themeStyles.muted}`}>
                                    {showSidebar ? <X size={20} className="md:hidden" /> : <Menu size={20} />}
                                    <span className="hidden md:inline ml-2"><Sidebar size={18} /></span>
                                </button>
                                <span className="text-xs uppercase tracking-wider opacity-30 flex items-center gap-1 hidden xs:flex">
                                    <Save size={12} /> Saved
                                </span>
                            </div>

                            {/* Icons container - scrollable on small screens */}
                            <div className="flex items-center gap-1 overflow-x-auto no-scrollbar mask-linear-gradient pl-2">
                                <div className="flex bg-black/5 rounded-lg p-1 mr-2 shrink-0">
                                    <button onClick={() => setTheme('light')} className={`p-1.5 rounded ${theme === 'light' ? 'bg-white shadow-sm text-black' : 'text-gray-400'}`}><Sun size={16}/></button>
                                    <button onClick={() => setTheme('sepia')} className={`p-1.5 rounded ${theme === 'sepia' ? 'bg-[#F4ECD8] shadow-sm text-[#5C4B37]' : 'text-gray-400'}`}><Coffee size={16}/></button>
                                    <button onClick={() => setTheme('dim')} className={`p-1.5 rounded ${theme === 'dim' ? 'bg-slate-700 shadow-sm text-white' : 'text-gray-400'}`}><Moon size={16}/></button>
                                    <button onClick={() => setTheme('dark')} className={`p-1.5 rounded ${theme === 'dark' ? 'bg-black shadow-sm text-white' : 'text-gray-400'}`}><Moon size={16} fill="currentColor" /></button>
                                </div>
                                <button onClick={() => setFont(font === 'serif' ? 'sans' : 'serif')} className={`p-2 shrink-0 rounded hover:bg-black/5 ${themeStyles.muted}`}><Type size={20} /></button>
                                <button onClick={() => setIsPreview(!isPreview)} className={`p-2 shrink-0 rounded hover:bg-black/5 ${isPreview ? themeStyles.accent : themeStyles.muted}`}>{isPreview ? <EyeOff size={20} /> : <Eye size={20} />}</button>
                                <button onClick={() => setShowHistoryModal(true)} className={`p-2 shrink-0 rounded hover:bg-black/5 ${themeStyles.muted}`}><History size={20} /></button>
                                <button onClick={() => setFocusMode(!focusMode)} className={`p-2 shrink-0 rounded hover:bg-black/5 ${focusMode ? 'text-blue-500' : themeStyles.muted}`}><div className={`w-3 h-3 rounded-full ${focusMode ? 'bg-blue-500' : 'bg-gray-300'}`} /></button>
                            </div>
                        </div>

                        {/* EDITOR */}
                        <div className="flex-1 overflow-y-auto relative w-full scroll-smooth">
                            {activeNote ? (
                                <div className="max-w-3xl mx-auto px-4 sm:px-8 md:px-12 py-6 md:py-12 min-h-full">
                                    {isPreview ? (
                                        <SimpleMarkdown content={activeNote.content} themeClass={theme} />
                                    ) : (
                                        <textarea
                                            ref={editorRef}
                                            value={activeNote.content}
                                            onChange={(e) => updateNote(activeNote.id, e.target.value)}
                                            placeholder="Start writing..."
                                            className={`
                                                w-full h-full min-h-[60vh] resize-none outline-none bg-transparent 
                                                leading-relaxed text-lg md:text-xl pb-32
                                                ${theme === 'dark' || theme === 'dim' ? 'selection:bg-blue-900 selection:text-blue-100' : 'selection:bg-blue-100 selection:text-blue-900'}
                                            `}
                                            spellCheck="false"
                                        />
                                    )}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full opacity-40 p-4 text-center">
                                    <FileText size={48} strokeWidth={1} />
                                    <p className="mt-4 text-lg">Select a note or create new</p>
                                </div>
                            )}
                        </div>

                        {/* MOBILE FOOTER STATS */}
                        <div className={`
                            h-8 border-t ${themeStyles.border} ${themeStyles.bg} flex items-center justify-between px-4 text-[10px] uppercase tracking-wider opacity-60
                            transition-opacity duration-300 absolute bottom-0 w-full pointer-events-none
                            ${focusMode && isTyping ? 'opacity-0' : 'opacity-100'}
                        `}>
                            <span>{wordCount} Words</span>
                            <span>Markdown Supported</span>
                        </div>
                    </div>

                    {/* HISTORY MODAL */}
                    {showHistoryModal && activeNote && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className={`${themeStyles.bg} ${themeStyles.text} w-full max-w-md rounded-xl shadow-2xl border ${themeStyles.border} flex flex-col max-h-[80vh]`}>
                                <div className={`p-4 border-b ${themeStyles.border} flex justify-between items-center`}>
                                    <h3 className="font-bold">History</h3>
                                    <button onClick={() => setShowHistoryModal(false)} className="p-1 hover:bg-black/5 rounded"><X size={20}/></button>
                                </div>
                                <div className="overflow-y-auto p-2 space-y-2 flex-1">
                                    {activeNote.versions?.length > 0 ? (
                                        [...activeNote.versions].reverse().map((v, i) => (
                                            <div key={i} className={`p-3 rounded border ${themeStyles.border} flex justify-between items-center bg-black/5`}>
                                                <div className="text-xs">
                                                    <div className="opacity-50">{new Date(v.time).toLocaleString()}</div>
                                                    <div className="truncate w-32 mt-1 font-mono">{v.content.slice(0,20)}...</div>
                                                </div>
                                                <button onClick={() => { updateNote(activeNote.id, v.content); setShowHistoryModal(false); }} className="px-3 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600">Restore</button>
                                            </div>
                                        ))
                                    ) : <div className="p-4 text-center opacity-50">No history available</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


