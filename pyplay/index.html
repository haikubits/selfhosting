<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PyPlayground - Client-Side Python IDE</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        accent: '#f59e0b',
                        darkbg: '#1e1e1e',
                        darkpanel: '#252526',
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Editor Overrides - Strict Absolute Positioning to fix Scroll */
        .CodeMirror { 
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100% !important; 
            font-family: 'Fira Code', monospace; 
            font-size: 14px; 
        }
        .cm-s-dracula.CodeMirror { background-color: #1e1e1e !important; }

        /* Loader Animation */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Confetti */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; opacity: 0; pointer-events: none; z-index: 9999; }
        @keyframes fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s ease-in; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-darkbg dark:text-gray-200 h-screen w-screen flex flex-col font-sans transition-colors duration-200 overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="flex flex-col h-full relative min-h-0">

        <!-- HEADER -->
        <header class="h-14 bg-white dark:bg-darkpanel border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-3 sm:px-4 shrink-0 z-30 shadow-sm relative">
            <div class="flex items-center gap-2 sm:gap-4 overflow-hidden">
                <div class="text-2xl shrink-0">üêç</div>
                
                <div class="flex items-center gap-2 overflow-hidden">
                    <h1 class="font-bold text-lg leading-tight hidden md:block mr-2">PyPlayground</h1>
                    
                    <!-- Mobile Project Selector (View Only) -->
                    <div class="relative max-w-[120px] sm:max-w-[200px] md:hidden">
                         <select id="projectSelect" class="w-full text-xs bg-transparent border-none outline-none font-bold text-gray-700 dark:text-gray-200 cursor-pointer hover:text-primary transition-colors truncate py-1 pr-6 appearance-none">
                            <!-- Options populated by JS -->
                        </select>
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 text-[10px]">‚ñº</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-1 sm:gap-2 shrink-0">
                <button id="btnNew" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="New Project (Cmd+N)">
                    <i class="fas fa-plus"></i>
                </button>
                
                <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-1 hidden sm:block"></div>
                
                <button id="btnRun" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-1.5 rounded-md font-semibold transition-transform active:scale-95 shadow-md" title="Run Code (Cmd+Enter)">
                    <i class="fas fa-play text-xs"></i> <span class="hidden sm:inline">Run</span>
                </button>
                <button id="btnStop" class="hidden items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-3 sm:px-4 py-1.5 rounded-md font-semibold transition-transform active:scale-95 shadow-md">
                    <i class="fas fa-stop text-xs"></i> <span class="hidden sm:inline">Stop</span>
                </button>
                
                <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-1 hidden sm:block"></div>
                
                <!-- Export button now always visible -->
                <button id="btnExport" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Export ZIP">
                    <i class="fas fa-download"></i>
                </button>
                <button id="btnSettings" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="btnTheme" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-yellow-500" title="Toggle Theme">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <!-- Added min-h-0 to prevent flex overflow issues -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative min-h-0">
            
            <!-- SIDEBAR (Projects/History) -->
            <aside id="sidebar" class="w-72 bg-gray-50 dark:bg-darkpanel border-r border-gray-200 dark:border-gray-700 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform absolute md:relative z-20 h-full shadow-xl md:shadow-none">
                <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <span class="font-semibold text-xs uppercase tracking-wider text-gray-500">Projects</span>
                    <button id="sidebarClose" class="md:hidden text-gray-500 p-2"><i class="fas fa-times"></i></button>
                </div>
                <div id="projectList" class="flex-1 overflow-y-auto p-2 space-y-1">
                    <!-- Projects populated via JS -->
                </div>
                <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                    <button id="btnSnippets" class="w-full text-xs bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded py-2 px-2 hover:bg-gray-50 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-code"></i> Insert Snippet
                    </button>
                </div>
            </aside>

            <!-- EDITOR AREA -->
            <section class="flex-1 flex flex-col min-w-0 bg-white dark:bg-[#1e1e1e] min-h-0">
                <!-- Tabs -->
                <div class="flex bg-gray-100 dark:bg-[#1e1e1e] border-b border-gray-200 dark:border-gray-700 overflow-x-auto shrink-0">
                    <button data-tab="editor" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary bg-white dark:bg-[#1e1e1e] whitespace-nowrap">Code</button>
                    <button data-tab="input" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap">Input</button>
                    <button data-tab="runs" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap">History</button>
                </div>

                <!-- Editor Pane -->
                <!-- Added relative and h-full for absolute positioning child -->
                <div id="editorPane" class="flex-1 relative overflow-hidden h-full">
                    <textarea id="codeEditor"></textarea>
                </div>

                <!-- Input Pane (Hidden by default) -->
                <div id="inputPane" class="flex-1 hidden flex-col bg-gray-50 dark:bg-darkbg p-4 overflow-y-auto min-h-0">
                    <label class="text-sm font-bold text-gray-600 dark:text-gray-400 mb-2 block">Standard Input (stdin)</label>
                    <textarea id="stdinInput" class="w-full h-40 p-3 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 font-mono text-sm resize-none focus:ring-2 focus:ring-primary outline-none transition" placeholder="Enter text that input() will read..."></textarea>
                    
                    <label class="text-sm font-bold text-gray-600 dark:text-gray-400 mt-4 mb-2 block">Command Line Arguments (argv)</label>
                    <input id="argvInput" type="text" class="w-full p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 font-mono text-sm focus:ring-2 focus:ring-primary outline-none" placeholder="arg1 arg2 arg3">
                </div>

                 <!-- Runs Pane (Hidden by default) -->
                 <div id="runsPane" class="flex-1 hidden bg-gray-50 dark:bg-darkbg overflow-y-auto p-2 min-h-0">
                    <div id="runsList" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </section>

            <!-- OUTPUT PANEL -->
            <section class="w-full md:w-1/3 border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700 flex flex-col bg-white dark:bg-darkpanel z-10 relative h-[35vh] md:h-auto shrink-0 md:shrink shadow-top md:shadow-none transition-all min-h-0" id="outputSection">
                <div class="flex items-center justify-between px-3 py-2 bg-gray-50 dark:bg-[#2d2d2d] border-b border-gray-200 dark:border-gray-700">
                    <span class="font-semibold text-xs uppercase tracking-wider">Output</span>
                    <div class="flex gap-2">
                         <button id="btnClear" class="text-xs text-gray-500 hover:text-red-500 p-1" title="Clear Output"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="outputContainer" class="flex-1 overflow-auto p-3 font-mono text-sm bg-white dark:bg-[#1e1e1e] whitespace-pre-wrap leading-relaxed select-text">
                    <div class="text-gray-400 italic text-center mt-10" id="emptyState">
                        Run code to see output here.<br>
                        <span class="text-xs opacity-70">Press Ctrl+Enter to run</span>
                    </div>
                </div>
                <div id="statusFooter" class="h-8 bg-blue-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between px-3 text-xs text-gray-500 dark:text-gray-400 shrink-0">
                    <div class="flex items-center gap-2">
                        <span id="engineStatus" class="flex items-center gap-1"><div class="loader w-3 h-3 border-2 border-gray-400 border-t-blue-500"></div> <span class="hidden sm:inline">Loading Python...</span></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="executionTime"></span>
                        <span id="exitCode"></span>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-darkpanel rounded-lg shadow-xl w-96 p-6 transform transition-all scale-95 modal-content">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label>Font Size</label>
                    <input type="number" id="fontSizeInput" class="w-16 p-1 border rounded dark:bg-gray-700" value="14">
                </div>
                <div class="flex justify-between items-center">
                    <label>Auto-Save</label>
                    <input type="checkbox" checked disabled class="accent-primary">
                </div>
                <div>
                    <button id="btnResetData" class="text-red-500 text-sm hover:underline">Reset All Data</button>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-600 closeModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Snippets Modal -->
    <div id="snippetsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-darkpanel rounded-lg shadow-xl w-[500px] max-w-[90%] p-6 transform transition-all scale-95 modal-content">
            <h2 class="text-xl font-bold mb-4">Code Snippets</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2" id="snippetGrid">
                <!-- Populated via JS -->
            </div>
            <div class="mt-6 flex justify-end">
                <button class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded mr-2 closeModal">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-10 right-4 flex flex-col gap-2 z-[60] pointer-events-none"></div>

    <!-- WORKER SCRIPT (Inlined) -->
    <script id="workerScript" type="javascript/worker">
        importScripts("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js");

        let pyodideReadyPromise = loadPyodide();
        let pyodide = null;

        self.onmessage = async (event) => {
            const { type, code, input, argv, id } = event.data;

            if (type === 'init') {
                try {
                    pyodide = await pyodideReadyPromise;
                    await pyodide.loadPackage("micropip");
                    self.postMessage({ type: 'ready' });
                } catch (err) {
                    self.postMessage({ type: 'error', error: err.toString() });
                }
                return;
            }

            if (type === 'run') {
                if (!pyodide) {
                    self.postMessage({ type: 'error', error: "Runtime not ready" });
                    return;
                }

                const startTime = performance.now();
                let output = [];
                let errorOutput = [];

                pyodide.setStdout({ batched: (msg) => { output.push(msg + "\n"); } });
                pyodide.setStderr({ batched: (msg) => { errorOutput.push(msg + "\n"); } });

                try {
                    if (input) {
                        const stdinWrapper = `
import sys
from io import StringIO
sys.stdin = StringIO('''${input.replace(/'/g, "\\'")}''')
`;
                        await pyodide.runPythonAsync(stdinWrapper);
                    } else {
                        await pyodide.runPythonAsync("import sys; from io import StringIO; sys.stdin = StringIO('')");
                    }

                    const argvStr = argv ? argv.split(' ').map(a => `'${a}'`).join(',') : '';
                    await pyodide.runPythonAsync(`import sys; sys.argv = ['main.py', ${argvStr}]`);

                    await pyodide.runPythonAsync(code);
                    
                    const endTime = performance.now();
                    self.postMessage({
                        type: 'result',
                        id: id,
                        stdout: output.join(''),
                        stderr: errorOutput.join(''),
                        duration: (endTime - startTime).toFixed(2),
                        exitCode: 0
                    });

                } catch (err) {
                    const endTime = performance.now();
                    self.postMessage({
                        type: 'result',
                        id: id,
                        stdout: output.join(''),
                        stderr: err.toString(),
                        duration: (endTime - startTime).toFixed(2),
                        exitCode: 1
                    });
                }
            }
        };
    </script>

    <!-- MAIN APP LOGIC -->
    <script>
        // --- DATA & CONSTANTS ---
        const SNIPPETS = [
            { label: 'Hello World', code: 'print("Hello, PyPlayground!")' },
            { label: 'Read Input', code: 'name = input("Enter name: ")\nprint(f"Hello, {name}!")' },
            { label: 'File I/O', code: 'with open("test.txt", "w") as f:\n    f.write("Data stored in virtual fs")\n\nwith open("test.txt", "r") as f:\n    print(f.read())' },
            { label: 'JSON Parsing', code: 'import json\ndata = {"key": "value"}\njson_str = json.dumps(data, indent=2)\nprint(json_str)' },
            { label: 'Loop & Math', code: 'for i in range(1, 6):\n    print(f"{i}^2 = {i**2}")' },
            { label: 'Sys Argv', code: 'import sys\nprint(f"Arguments: {sys.argv}")' },
        ];

        const state = {
            projects: [],
            currentProjectId: null,
            editingId: null, // Tracks which project is being edited
            theme: localStorage.getItem('theme') || 'dark',
            isWorkerReady: false,
            isRunning: false,
            runCounter: 0
        };

        let editor;
        let worker;
        let autoSaveTimer;

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            btnRun: document.getElementById('btnRun'),
            btnStop: document.getElementById('btnStop'),
            btnNew: document.getElementById('btnNew'),
            btnTheme: document.getElementById('btnTheme'),
            btnExport: document.getElementById('btnExport'),
            btnSettings: document.getElementById('btnSettings'),
            btnClear: document.getElementById('btnClear'),
            btnSnippets: document.getElementById('btnSnippets'),
            projectSelect: document.getElementById('projectSelect'),
            projectList: document.getElementById('projectList'),
            editorPane: document.getElementById('editorPane'),
            inputPane: document.getElementById('inputPane'),
            runsPane: document.getElementById('runsPane'),
            stdinInput: document.getElementById('stdinInput'),
            argvInput: document.getElementById('argvInput'),
            outputContainer: document.getElementById('outputContainer'),
            engineStatus: document.getElementById('engineStatus'),
            executionTime: document.getElementById('executionTime'),
            exitCode: document.getElementById('exitCode'),
            sidebar: document.getElementById('sidebar'),
            sidebarClose: document.getElementById('sidebarClose'),
            snippetsModal: document.getElementById('snippetsModal'),
            settingsModal: document.getElementById('settingsModal'),
            snippetGrid: document.getElementById('snippetGrid'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            btnResetData: document.getElementById('btnResetData'),
            runsList: document.getElementById('runsList'),
        };

        // --- GLOBAL ACTIONS (Window Attached) ---
        
        window.loadProject = function(id) {
            // Prevent loading if we are currently clicking an edit button
            if (state.editingId) return;

            const project = state.projects.find(p => p.id === id);
            if (!project) return;

            if (state.currentProjectId && state.currentProjectId !== id) {
                saveCurrentProjectState();
            }

            state.currentProjectId = id;
            localStorage.setItem('lastProjectId', id);

            editor.setValue(project.code);
            els.stdinInput.value = project.stdin || '';
            els.argvInput.value = project.argv || '';
            
            els.outputContainer.innerHTML = '<div class="text-gray-400 italic text-center mt-10">Ready to run.</div>';
            els.executionTime.textContent = '';
            els.exitCode.textContent = '';

            renderRuns(project);
            updateProjectSelect();
            highlightActiveProject();
            
            // Close sidebar on mobile on selection
            if (window.innerWidth < 768) {
                els.sidebar.classList.add('-translate-x-full');
            }
        };

        window.startEdit = function(id, event) {
            if(event) {
                event.stopPropagation();
                event.preventDefault();
            }
            state.editingId = id;
            renderProjectList();
            
            // Auto focus the input
            setTimeout(() => {
                const input = document.getElementById(`edit-${id}`);
                if(input) {
                    input.focus();
                    input.select();
                    // Add listener for Enter key
                    input.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') {
                            window.saveEdit(id, e);
                        }
                    });
                }
            }, 50);
        };

        window.saveEdit = function(id, event) {
            if(event) {
                event.stopPropagation();
                event.preventDefault();
            }
            const input = document.getElementById(`edit-${id}`);
            if(input) {
                const newVal = input.value.trim();
                const project = state.projects.find(p => p.id === id);
                if(project && newVal) {
                    project.title = newVal;
                    saveData();
                    updateProjectSelect(); // update header select too
                }
            }
            state.editingId = null;
            renderProjectList();
        };

        window.deleteProject = function(id, event) {
            if(event) {
                event.stopPropagation();
                event.preventDefault();
            }

            if (state.projects.length <= 1) {
                showToast("Cannot delete last project", "error");
                return;
            }
            if(confirm("Are you sure you want to delete this project? This cannot be undone.")) {
                state.projects = state.projects.filter(p => p.id !== id);
                saveData();
                
                if (state.currentProjectId === id) {
                    // Load the first available project
                    // reset editing state to avoid glitches
                    state.editingId = null;
                    const nextId = state.projects[0].id;
                    // Directly call logic to load without checks
                    state.currentProjectId = nextId;
                    localStorage.setItem('lastProjectId', nextId);
                    const p = state.projects[0];
                    editor.setValue(p.code);
                    els.stdinInput.value = p.stdin || '';
                    els.argvInput.value = p.argv || '';
                    renderRuns(p);
                }
                
                state.editingId = null;
                renderProjectList();
                updateProjectSelect();
                showToast("Project Deleted");
            }
        };

        window.insertSnippet = function(encodedCode) {
            const code = decodeURIComponent(encodedCode);
            editor.setValue(editor.getValue() + '\n' + code);
            closeModal(els.snippetsModal);
            showToast("Snippet Inserted");
        };

        // --- CORE FUNCTIONS ---

        function init() {
            initWorker();
            initEditor();
            loadData();
            applyTheme(state.theme);
            renderProjectList();
            setupEventListeners();
            
            els.snippetGrid.innerHTML = SNIPPETS.map(s => 
                `<button class="text-left p-3 border dark:border-gray-600 rounded hover:border-primary hover:bg-blue-50 dark:hover:bg-gray-700 transition" onclick="insertSnippet('${encodeURIComponent(s.code)}')">
                    <div class="font-bold text-sm">${s.label}</div>
                    <div class="text-xs text-gray-400 font-mono truncate">${s.code.split('\n')[0]}</div>
                 </button>`
            ).join('');

            if (state.projects.length === 0) {
                createNewProject("Hello World");
            } else {
                const lastId = localStorage.getItem('lastProjectId');
                const target = state.projects.find(p => p.id === lastId) || state.projects[0];
                // Force load logic manually to avoid early return issues
                state.currentProjectId = target.id;
                editor.setValue(target.code);
                els.stdinInput.value = target.stdin || '';
                els.argvInput.value = target.argv || '';
                renderRuns(target);
                updateProjectSelect();
                highlightActiveProject();
            }
        }

        function initWorker() {
            const blob = new Blob([document.getElementById('workerScript').textContent], { type: "text/javascript" });
            worker = new Worker(window.URL.createObjectURL(blob));
            
            worker.postMessage({ type: 'init' });

            worker.onmessage = (e) => {
                const { type, stdout, stderr, exitCode, duration, error } = e.data;
                if (type === 'ready') {
                    state.isWorkerReady = true;
                    els.engineStatus.innerHTML = '<span class="text-green-600 font-bold">‚óè Ready</span>';
                } else if (type === 'result') {
                    finishRun(stdout, stderr, exitCode, duration);
                } else if (type === 'error') {
                    finishRun("", error, 1, 0);
                }
            };
        }

        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: state.theme === 'dark' ? 'dracula' : 'eclipse',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true,
            });
            editor.on('change', debounceSave);
            
            const savedSize = localStorage.getItem('fontSize') || 14;
            els.fontSizeInput.value = savedSize;
            setFontSize(savedSize);
        }

        function runCode() {
            if (!state.isWorkerReady || state.isRunning) return;

            state.isRunning = true;
            toggleRunState(true);
            
            els.outputContainer.innerHTML = '';
            els.executionTime.textContent = '';
            els.exitCode.textContent = '';

            const code = editor.getValue();
            const input = els.stdinInput.value;
            const argv = els.argvInput.value;
            state.runCounter++;

            // Ensure output is visible on mobile
            if(window.innerWidth < 768) {
               document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
            }

            worker.postMessage({ type: 'run', code, input, argv, id: state.runCounter });

            setTimeout(() => {
                if (state.isRunning) {
                    worker.terminate();
                    finishRun("", "Error: Execution timed out (10s limit).", 124, 10000);
                    initWorker();
                }
            }, 10000);
        }

        function finishRun(stdout, stderr, exitCode, duration) {
            state.isRunning = false;
            toggleRunState(false);
            
            const outElem = document.createElement('div');
            outElem.className = "text-gray-800 dark:text-gray-200";
            outElem.textContent = stdout;
            els.outputContainer.appendChild(outElem);

            if (stderr) {
                const errElem = document.createElement('div');
                errElem.className = "text-red-500 mt-2 p-2 bg-red-50 dark:bg-red-900/20 border-l-2 border-red-500 rounded-r";
                errElem.textContent = stderr;
                els.outputContainer.appendChild(errElem);
            }

            els.executionTime.textContent = `${duration}ms`;
            els.exitCode.textContent = `Exit: ${exitCode}`;
            els.exitCode.className = exitCode === 0 ? "text-green-600 font-mono" : "text-red-600 font-bold font-mono";

            const project = getCurrentProject();
            const runData = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                stdout, stderr, exitCode, duration
            };
            project.runs.unshift(runData);
            if (project.runs.length > 10) project.runs.pop();
            saveData();
            renderRuns(project);

            if (exitCode === 0 && stdout.trim().length > 0) {
                confettiEffect();
                showToast("Success", "success");
            } else if (exitCode !== 0) {
                showToast("Failed", "error");
            }
        }

        function toggleRunState(running) {
            if (running) {
                els.btnRun.classList.add('hidden');
                els.btnStop.classList.remove('hidden');
                els.btnStop.classList.add('flex');
                els.engineStatus.innerHTML = '<div class="loader w-3 h-3 border-2 border-yellow-500"></div> Running...';
            } else {
                els.btnRun.classList.remove('hidden');
                els.btnStop.classList.add('hidden');
                els.btnStop.classList.remove('flex');
                els.engineStatus.innerHTML = '<span class="text-green-600 font-bold">‚óè Ready</span>';
            }
        }

        function getCurrentProject() {
            return state.projects.find(p => p.id === state.currentProjectId);
        }

        function createNewProject(code = 'print("Hello World")') {
            const newProject = {
                id: 'proj_' + Date.now(),
                title: 'Untitled ' + (state.projects.length + 1),
                code: code,
                stdin: '',
                argv: '',
                runs: []
            };
            state.projects.push(newProject);
            saveData();
            loadProject(newProject.id);
            renderProjectList();
            showToast("New Project Created");
        }

        function saveCurrentProjectState() {
            const project = getCurrentProject();
            if (project) {
                project.code = editor.getValue();
                project.stdin = els.stdinInput.value;
                project.argv = els.argvInput.value;
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('pyplayground_data', JSON.stringify(state.projects));
        }

        function loadData() {
            const raw = localStorage.getItem('pyplayground_data');
            if (raw) {
                try {
                    state.projects = JSON.parse(raw);
                } catch(e) {
                    state.projects = [];
                }
            }
        }

        function debounceSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveCurrentProjectState();
                const indicator = document.createElement('span');
                indicator.textContent = 'Saved';
                indicator.className = 'text-[10px] text-gray-400 absolute bottom-1 right-2 z-20 font-sans';
                document.getElementById('editorPane').appendChild(indicator);
                setTimeout(() => indicator.remove(), 1000);
            }, 1000);
        }

        function renderProjectList() {
            els.projectList.innerHTML = state.projects.map(p => {
                const isEditing = state.editingId === p.id;
                const isActive = p.id === state.currentProjectId;
                
                let contentHTML = '';
                let actionsHTML = '';

                if (isEditing) {
                    // EDIT MODE
                    contentHTML = `<input id="edit-${p.id}" type="text" value="${p.title}" class="w-full text-sm bg-white dark:bg-gray-600 border border-primary rounded px-1 py-0.5 text-gray-800 dark:text-gray-100 outline-none relative z-30" onclick="event.stopPropagation()">`;
                    actionsHTML = `<button class="text-green-500 hover:text-green-600 p-2 ml-1 relative z-30" onclick="saveEdit('${p.id}', event)"><i class="fas fa-check"></i></button>`;
                } else {
                    // VIEW MODE
                    contentHTML = `<div class="truncate text-sm font-medium ${isActive ? 'text-primary' : 'text-gray-600 dark:text-gray-300'} pointer-events-none">${p.title}</div>`;
                    actionsHTML = `
                        <div class="flex items-center">
                            <button class="text-gray-400 hover:text-primary p-2 transition-colors relative z-20" title="Rename" onclick="startEdit('${p.id}', event)">
                                <i class="fas fa-pen text-[10px]"></i>
                            </button>
                            <button class="text-gray-400 hover:text-red-500 p-2 transition-colors relative z-20" title="Delete" onclick="deleteProject('${p.id}', event)">
                                <i class="fas fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    `;
                }

                // Strict separation: Background click vs foreground actions
                return `
                    <div class="group flex items-center justify-between p-2 rounded hover:bg-white dark:hover:bg-gray-700 transition relative mb-1 ${isActive ? 'bg-white dark:bg-gray-700 border-l-4 border-primary' : 'border-l-4 border-transparent'}">
                        <!-- Background Click Target -->
                        <div class="absolute inset-0 z-0 cursor-pointer" onclick="loadProject('${p.id}')"></div>
                        
                        <!-- Foreground Content -->
                        <div class="flex-1 min-w-0 mr-2 relative z-10 pointer-events-none">
                            ${contentHTML}
                        </div>
                        
                        <!-- Foreground Actions -->
                        <div class="shrink-0 flex items-center relative z-20">
                            ${actionsHTML}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateProjectSelect();
        }

        function updateProjectSelect() {
            els.projectSelect.innerHTML = state.projects.map(p => 
                `<option value="${p.id}" ${p.id === state.currentProjectId ? 'selected' : ''}>${p.title}</option>`
            ).join('');
        }
        
        function highlightActiveProject() {
             renderProjectList();
        }

        function renderRuns(project) {
            if (!project.runs.length) {
                els.runsList.innerHTML = '<div class="text-center text-gray-400 text-sm mt-4">No runs recorded yet.</div>';
                return;
            }

            els.runsList.innerHTML = project.runs.map((r) => `
                <div class="bg-white dark:bg-gray-800 p-3 rounded border-l-4 ${r.exitCode === 0 ? 'border-green-500' : 'border-red-500'} shadow-sm text-sm">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>${r.timestamp.split(',')[1]}</span>
                        <span>${r.duration}ms</span>
                    </div>
                    <div class="font-mono text-xs truncate text-gray-600 dark:text-gray-300 mb-1">
                        Exit: ${r.exitCode}
                    </div>
                    <div class="max-h-16 overflow-hidden text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-black/20 p-1 rounded font-mono">
                        ${r.stdout || r.stderr || '(No Output)'}
                    </div>
                </div>
            `).join('');
        }

        function applyTheme(theme) {
            state.theme = theme;
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                els.btnTheme.innerHTML = '<i class="fas fa-moon"></i>';
                if(editor) editor.setOption('theme', 'dracula');
            } else {
                document.documentElement.classList.remove('dark');
                els.btnTheme.innerHTML = '<i class="fas fa-sun"></i>';
                if(editor) editor.setOption('theme', 'eclipse');
            }
        }

        function setFontSize(size) {
            document.querySelector('.CodeMirror').style.fontSize = `${size}px`;
            editor.refresh();
            localStorage.setItem('fontSize', size);
        }

        function exportZip() {
            const project = getCurrentProject();
            const zip = new JSZip();
            zip.file("main.py", project.code);
            zip.file("input.txt", project.stdin);
            if (project.runs.length > 0) {
                const lastRun = project.runs[0];
                zip.file("stdout.txt", lastRun.stdout);
                zip.file("stderr.txt", lastRun.stderr);
                zip.file("run_info.json", JSON.stringify(lastRun, null, 2));
            }
            
            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `${project.title.replace(/\s+/g, '_')}.zip`;
                a.click();
                showToast("Project Exported");
            });
        }

        function confettiEffect() {
            for (let i = 0; i < 30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random() * 5)];
                c.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `px-4 py-2 rounded shadow-lg text-white text-sm font-semibold flex items-center gap-2 transform transition-all pointer-events-auto ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-800'}`;
            t.innerHTML = `<span>${msg}</span>`;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'toast-enter';
            wrapper.appendChild(t);
            
            document.getElementById('toastContainer').appendChild(wrapper);
            
            requestAnimationFrame(() => wrapper.className = 'toast-enter-active');

            setTimeout(() => {
                wrapper.className = 'toast-exit-active';
                setTimeout(() => wrapper.remove(), 300);
            }, 3000);
        }

        function openModal(modal) {
            modal.classList.remove('hidden', 'pointer-events-none');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            // Animate content
            const content = modal.querySelector('.modal-content');
            if(content) content.classList.remove('scale-95');
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            const content = modal.querySelector('.modal-content');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden', 'pointer-events-none');
            }, 200);
        }

        function setupEventListeners() {
            els.btnTheme.onclick = () => applyTheme(state.theme === 'dark' ? 'light' : 'dark');
            els.btnRun.onclick = runCode;
            els.btnStop.onclick = () => { if(state.isRunning && worker) worker.terminate(); initWorker(); finishRun("", "Stopped by user", 130, 0); };
            els.btnNew.onclick = () => createNewProject();
            els.btnExport.onclick = exportZip;
            
            els.btnClear.onclick = () => { els.outputContainer.innerHTML = ''; };

            els.projectSelect.onchange = (e) => window.loadProject(e.target.value);

            els.btnSettings.onclick = () => openModal(els.settingsModal);
            els.btnSnippets.onclick = () => openModal(els.snippetsModal);
            
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.onclick = function() {
                    closeModal(this.closest('.fixed'));
                }
            });

            els.fontSizeInput.onchange = (e) => setFontSize(e.target.value);

            els.btnResetData.onclick = () => {
                if(confirm("Delete all projects and settings? This cannot be undone.")) {
                    localStorage.removeItem('pyplayground_data');
                    localStorage.removeItem('lastProjectId');
                    location.reload();
                }
            }

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('border-primary', 'text-primary', 'bg-white', 'dark:bg-[#1e1e1e]');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-primary', 'text-primary', 'bg-white', 'dark:bg-[#1e1e1e]');

                    els.editorPane.classList.add('hidden');
                    els.inputPane.classList.add('hidden');
                    els.runsPane.classList.add('hidden');

                    const target = btn.dataset.tab;
                    if(target === 'editor') {
                        els.editorPane.classList.remove('hidden');
                        editor.refresh();
                    } else if (target === 'input') {
                        els.inputPane.classList.remove('hidden');
                        els.inputPane.style.display = 'flex';
                    } else {
                        els.runsPane.classList.remove('hidden');
                    }
                };
            });

            const toggleSidebar = () => {
                els.sidebar.classList.toggle('-translate-x-full');
            };
            
            const hamburger = document.createElement('button');
            hamburger.className = 'md:hidden mr-2 text-gray-500 p-2';
            hamburger.innerHTML = '<i class="fas fa-bars"></i>';
            hamburger.onclick = toggleSidebar;
            document.querySelector('header > div').prepend(hamburger);
            els.sidebarClose.onclick = toggleSidebar;

            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runCode();
                }
                if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                    e.preventDefault();
                    saveCurrentProjectState();
                    showToast("Saved");
                }
                if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
                    e.preventDefault();
                    toggleSidebar();
                }
            });
        }

        // --- BOOT ---
        init();

    </script>
</body>
</html>
