<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeBlocks</title>
    
    <!-- 1. Configure Tailwind BEFORE loading the script -->
    <script>
        window.tailwind = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            950: '#0a0a0a',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-200">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ROBUST ICON COMPONENTS ---
        // Defined individually to prevent Babel/Scoping errors
        
        const IconBase = ({ children, size = 20, className = "", onClick }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} height={size} 
                viewBox="0 0 24 24" 
                fill="none" stroke="currentColor" 
                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                className={className}
                onClick={onClick}
            >
                {children}
            </svg>
        );

        const CalendarIcon = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const ChevronLeftIcon = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRightIcon = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const PlusIcon = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const XIcon = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const CheckIcon = (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>;
        const TrashIcon = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const SearchIcon = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const DownloadIcon = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const UploadIcon = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const MoonIcon = (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const SunIcon = (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const ClockIcon = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const PieChartIcon = (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const MenuIcon = (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;

        // --- UTILS ---
        const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        };
        const formatDateKey = (date) => date.toISOString().split('T')[0];
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const parseTime = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };
        const formatTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        // --- COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const base = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 select-none";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm active:scale-95",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700 active:scale-95",
                danger: "bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400 active:scale-95",
                ghost: "hover:bg-gray-100 text-gray-600 dark:text-gray-400 dark:hover:bg-gray-800 active:scale-95",
                icon: "p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 active:scale-90"
            };
            return (
                <button className={`${base} ${variants[variant]} ${className}`} onClick={onClick} {...props}>
                {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto animate-[slideUp_0.3s_ease-out]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-800 sticky top-0 bg-white dark:bg-gray-900 z-10">
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-500">
                                <XIcon size={20} />
                            </button>
                        </div>
                        <div className="p-4">{children}</div>
                    </div>
                </div>
            );
        };

        // --- APP ---
        function TimeBlocks() {
            const [entries, setEntries] = useState(() => {
                try {
                    const saved = localStorage.getItem('timeblocks-data');
                    return saved ? JSON.parse(saved) : [];
                } catch(e) { return []; }
            });
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('calendar'); 
            const [theme, setTheme] = useState(() => localStorage.getItem('timeblocks-theme') || 'light');
            const [isEntryModalOpen, setIsEntryModalOpen] = useState(false);
            const [editingEntry, setEditingEntry] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            const [showMenu, setShowMenu] = useState(false);

            const today = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const currentDayKey = formatDateKey(currentDate);

            useEffect(() => { localStorage.setItem('timeblocks-data', JSON.stringify(entries)); }, [entries]);
            useEffect(() => {
                localStorage.setItem('timeblocks-theme', theme);
                document.documentElement.classList.toggle('dark', theme === 'dark');
            }, [theme]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); setShowSearch(prev => !prev); }
                    if (e.key === 'Escape') { setIsEntryModalOpen(false); setShowSearch(false); }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const addEntry = (entry) => {
                setEntries(prev => [...prev, { ...entry, id: generateId(), status: entry.status || 'planned' }]);
                setIsEntryModalOpen(false); setEditingEntry(null);
            };
            const updateEntry = (updatedEntry) => {
                setEntries(prev => prev.map(e => e.id === updatedEntry.id ? updatedEntry : e));
                setIsEntryModalOpen(false); setEditingEntry(null);
            };
            const deleteEntry = (id) => {
                if (confirm('Delete this entry?')) {
                    setEntries(prev => prev.filter(e => e.id !== id));
                    setIsEntryModalOpen(false); setEditingEntry(null);
                }
            };
            const toggleStatus = (id, e) => {
                e.stopPropagation();
                setEntries(prev => prev.map(entry => {
                    if (entry.id === id) return { ...entry, status: entry.status === 'done' ? 'planned' : 'done' };
                    return entry;
                }));
            };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `timeblocks-backup-${formatDateKey(new Date())}.json`;
                a.click(); URL.revokeObjectURL(url);
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            if (Array.isArray(imported)) { setEntries(imported); alert('Data imported successfully!'); }
                        } catch (err) { alert('Invalid JSON file.'); }
                    };
                    reader.readAsText(file);
                }
            };
            
            const dayStats = useMemo(() => {
                const daysEntries = entries.filter(e => e.date === currentDayKey);
                const totalPlanned = daysEntries.reduce((acc, curr) => acc + curr.duration, 0);
                const totalDone = daysEntries.filter(e => e.status === 'done').reduce((acc, curr) => acc + curr.duration, 0);
                return { totalPlanned, totalDone, count: daysEntries.length };
            }, [entries, currentDayKey]);

            const filteredEntries = useMemo(() => {
                if (!searchQuery) return [];
                const lowerQ = searchQuery.toLowerCase();
                return entries.filter(e => 
                    e.title.toLowerCase().includes(lowerQ) || 
                    (e.description && e.description.toLowerCase().includes(lowerQ))
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [entries, searchQuery]);

            const changeMonth = (offset) => setCurrentDate(new Date(currentYear, currentMonth + offset, 1));
            const changeDay = (offset) => { const newDate = new Date(currentDate); newDate.setDate(currentDate.getDate() + offset); setCurrentDate(newDate); };

            // Render logic
            const renderCalendarDays = () => {
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const firstDay = getFirstDayOfMonth(currentYear, currentMonth);
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-24 md:h-32 bg-gray-50/50 dark:bg-gray-900/50 border border-gray-100 dark:border-gray-800"></div>);
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const dateKey = formatDateKey(date);
                    const dayEntries = entries.filter(e => e.date === dateKey);
                    const isToday = dateKey === formatDateKey(today);
                    const isSelected = dateKey === formatDateKey(currentDate);
                    const doneCount = dayEntries.filter(e => e.status === 'done').length;
                    days.push(
                        <div key={d} onClick={() => { setCurrentDate(date); setView('day'); }} className={`h-24 md:h-32 border border-gray-100 dark:border-gray-800 p-2 cursor-pointer transition-colors relative group overflow-hidden ${isToday ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800'} ${isSelected ? 'ring-2 ring-inset ring-blue-500' : ''}`}>
                            <div className="flex justify-between items-start">
                                <span className={`text-sm font-semibold w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : 'text-gray-700 dark:text-gray-300'}`}>{d}</span>
                                {dayEntries.length > 0 && <div className="flex gap-1">{doneCount > 0 && <span className="text-xs font-bold text-green-600 dark:text-green-400">{doneCount}âœ“</span>}</div>}
                            </div>
                            <div className="mt-2 space-y-1 overflow-hidden">
                                {dayEntries.slice(0, 3).map(e => <div key={e.id} className={`text-[10px] truncate px-1 rounded-sm border-l-2 ${e.status === 'done' ? 'border-green-500 text-gray-400 line-through' : 'border-blue-500 text-gray-600 dark:text-gray-300'}`}>{e.title}</div>)}
                                {dayEntries.length > 3 && <div className="text-[10px] text-gray-400 pl-1">+{dayEntries.length - 3} more</div>}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            const renderTimeline = () => {
                const slots = [];
                const dayEntries = entries.filter(e => e.date === currentDayKey);
                const pxPerMin = 2; 
                for (let h = 0; h < 24; h++) {
                    slots.push(
                        <div key={h} className="flex border-b border-gray-100 dark:border-gray-800 relative group" style={{ height: `${60 * pxPerMin}px` }}>
                            <div className="w-16 text-xs text-gray-400 text-right pr-4 -mt-2.5 bg-white dark:bg-gray-950 z-10 sticky left-0 font-mono">{h.toString().padStart(2, '0')}:00</div>
                            <div className="flex-1 hover:bg-gray-50 dark:hover:bg-gray-900/50 cursor-pointer transition-colors" onClick={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const y = e.clientY - rect.top;
                                const mins = Math.floor(y / pxPerMin);
                                const totalMins = h * 60 + mins;
                                const roundedMins = Math.round(totalMins / 15) * 15;
                                const startH = Math.floor(roundedMins / 60);
                                const startM = roundedMins % 60;
                                setEditingEntry({ date: currentDayKey, startTime: `${startH.toString().padStart(2, '0')}:${startM.toString().padStart(2, '0')}`, duration: 60, title: '', description: '', color: 'blue' });
                                setIsEntryModalOpen(true);
                            }}></div>
                        </div>
                    );
                }
                return (
                    <div className="relative bg-white dark:bg-gray-950 rounded-lg shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
                        <div className="absolute top-0 left-0 w-full">{slots}</div>
                        {formatDateKey(today) === currentDayKey && (
                            <div className="absolute left-16 right-0 border-t-2 border-red-500 z-20 pointer-events-none opacity-80" style={{ top: `${(today.getHours() * 60 + today.getMinutes()) * pxPerMin}px` }}>
                                <div className="absolute -left-2 -top-1.5 w-3 h-3 bg-red-500 rounded-full shadow-sm"></div>
                            </div>
                        )}
                        <div className="relative ml-16 h-[2880px]" style={{ height: `${24 * 60 * pxPerMin}px` }}>
                            {dayEntries.map(entry => {
                                const startMins = parseTime(entry.startTime);
                                const height = entry.duration * pxPerMin;
                                const top = startMins * pxPerMin;
                                const colors = {
                                    blue: 'bg-blue-100 dark:bg-blue-900/40 border-blue-500 text-blue-900 dark:text-blue-100',
                                    green: 'bg-green-100 dark:bg-green-900/40 border-green-500 text-green-900 dark:text-green-100',
                                    purple: 'bg-purple-100 dark:bg-purple-900/40 border-purple-500 text-purple-900 dark:text-purple-100',
                                    orange: 'bg-orange-100 dark:bg-orange-900/40 border-orange-500 text-orange-900 dark:text-orange-100',
                                    gray: 'bg-gray-100 dark:bg-gray-800 border-gray-500 text-gray-900 dark:text-gray-300',
                                };
                                const isDone = entry.status === 'done';
                                return (
                                    <div key={entry.id} onClick={() => { setEditingEntry(entry); setIsEntryModalOpen(true); }} style={{ top: `${top}px`, height: `${height}px` }} className={`absolute left-1 right-2 rounded border-l-4 p-2 text-xs md:text-sm cursor-pointer hover:brightness-95 transition-all shadow-sm z-10 overflow-hidden flex flex-col justify-between ${colors[entry.color || 'blue']} ${isDone ? 'opacity-60 grayscale-[0.5]' : ''}`}>
                                        <div className="flex justify-between items-start gap-2">
                                            <span className={`font-bold truncate ${isDone ? 'line-through' : ''}`}>{entry.title || '(No Title)'}</span>
                                            <button onClick={(e) => toggleStatus(entry.id, e)} className={`p-0.5 rounded-full hover:bg-black/10 transition-colors ${isDone ? 'text-green-600 dark:text-green-400' : 'text-gray-400'}`}>{isDone ? <CheckIcon size={14} /> : <div className="w-3.5 h-3.5 border-2 border-current rounded-sm"></div>}</button>
                                        </div>
                                        {height > 40 && <div className="opacity-80 truncate text-[10px] md:text-xs">{entry.startTime} - {formatTime(startMins + entry.duration)}</div>}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen font-sans`}>
                    <header className="sticky top-0 z-40 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 py-3">
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">
                                    <ClockIcon size={20} />
                                </div>
                                <h1 className="text-xl font-bold tracking-tight hidden md:block">TimeBlocks</h1>
                            </div>
                            <div className="flex items-center gap-2 md:gap-4">
                                <div className="hidden md:flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                                    <button onClick={() => setView('calendar')} className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${view === 'calendar' ? 'bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900'}`}>Month</button>
                                    <button onClick={() => setView('day')} className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${view === 'day' ? 'bg-white dark:bg-gray-700 shadow text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900'}`}>Day</button>
                                </div>
                                <Button variant="ghost" onClick={() => setShowSearch(true)} className="md:w-64 justify-start text-gray-500 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"><SearchIcon size={16} /><span className="hidden md:inline text-xs">Search (Cmd+K)</span></Button>
                                <Button variant="icon" onClick={() => setTheme(t => t === 'light' ? 'dark' : 'light')}>{theme === 'light' ? <MoonIcon size={18} /> : <SunIcon size={18} />}</Button>
                                <div className="md:hidden"><Button variant="icon" onClick={() => setShowMenu(!showMenu)}><MenuIcon size={20} /></Button></div>
                            </div>
                        </div>
                        {showMenu && (
                            <div className="md:hidden absolute top-full left-0 right-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-4 shadow-xl flex flex-col gap-3 animate-[slideDown_0.2s_ease-out]">
                                <div className="flex gap-2">
                                    <Button className="flex-1 justify-center" variant={view === 'calendar' ? 'primary' : 'secondary'} onClick={() => {setView('calendar'); setShowMenu(false)}}>Month</Button>
                                    <Button className="flex-1 justify-center" variant={view === 'day' ? 'primary' : 'secondary'} onClick={() => {setView('day'); setShowMenu(false)}}>Day</Button>
                                </div>
                                <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                                <div className="flex justify-between items-center text-sm text-gray-500">
                                    <span>Backup Data</span>
                                    <div className="flex gap-2">
                                        <Button variant="icon" onClick={handleExport} title="Export"><DownloadIcon size={16}/></Button>
                                        <label className="cursor-pointer p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300"><UploadIcon size={16} /><input type="file" className="hidden" accept=".json" onChange={handleImport} /></label>
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-6xl mx-auto p-4">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center bg-white dark:bg-gray-900 rounded-lg shadow-sm border border-gray-200 dark:border-gray-800 p-1">
                                    <button onClick={() => view === 'calendar' ? changeMonth(-1) : changeDay(-1)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"><ChevronLeftIcon size={20} /></button>
                                    <button onClick={() => view === 'calendar' ? changeMonth(1) : changeDay(1)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"><ChevronRightIcon size={20} /></button>
                                </div>
                                <h2 className="text-xl md:text-2xl font-bold">{currentDate.toLocaleDateString('default', { month: 'long', year: 'numeric' })}{view === 'day' && <span className="text-gray-400 font-normal ml-2 text-lg">{currentDate.getDate()}</span>}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <Button variant="secondary" onClick={() => { setCurrentDate(new Date()); setView('day'); }}>Today</Button>
                                <Button onClick={() => { setEditingEntry({ date: currentDayKey, startTime: '09:00', duration: 60, title: '', description: '', color: 'blue' }); setIsEntryModalOpen(true); }}><PlusIcon size={18} /><span className="hidden md:inline">Add Entry</span></Button>
                                <div className="hidden md:flex gap-1 ml-2 border-l border-gray-300 dark:border-gray-700 pl-3">
                                    <Button variant="icon" onClick={handleExport} title="Export Data"><DownloadIcon size={18} /></Button>
                                    <label className="cursor-pointer p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300" title="Import Data"><UploadIcon size={18} /><input type="file" className="hidden" accept=".json" onChange={handleImport} /></label>
                                </div>
                            </div>
                        </div>

                        {view === 'calendar' ? (
                            <div className="animate-[fadeIn_0.3s_ease-out]">
                                <div className="grid grid-cols-7 gap-px mb-2">{['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => <div key={d} className="text-center text-xs md:text-sm font-semibold text-gray-500 uppercase tracking-wider py-2">{d}</div>)}</div>
                                <div className="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-800 border border-gray-200 dark:border-gray-800 rounded-lg overflow-hidden">{renderCalendarDays()}</div>
                            </div>
                        ) : (
                            <div className="flex flex-col lg:flex-row gap-6 animate-[fadeIn_0.3s_ease-out]">
                                <div className="flex-1 order-2 lg:order-1">{renderTimeline()}</div>
                                <div className="w-full lg:w-80 order-1 lg:order-2 space-y-6">
                                    <div className="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm sticky top-24">
                                        <div className="flex items-center gap-2 mb-4 text-gray-500"><PieChartIcon size={18} /><span className="text-xs font-bold uppercase tracking-wider">Day Overview</span></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg"><div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{Math.round(dayStats.totalPlanned / 60 * 10) / 10}h</div><div className="text-xs text-blue-600/70 dark:text-blue-400/70 font-medium">Planned</div></div>
                                            <div className="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg"><div className="text-2xl font-bold text-green-600 dark:text-green-400">{Math.round(dayStats.totalDone / 60 * 10) / 10}h</div><div className="text-xs text-green-600/70 dark:text-green-400/70 font-medium">Completed</div></div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                                            <div className="flex justify-between text-sm"><span className="text-gray-500">Tasks</span><span className="font-medium">{dayStats.count} entries</span></div>
                                            {dayStats.totalPlanned > 0 && <div className="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2 mt-2 overflow-hidden"><div className="bg-green-500 h-full transition-all duration-500" style={{ width: `${Math.min((dayStats.totalDone / dayStats.totalPlanned) * 100, 100)}%` }}></div></div>}
                                        </div>
                                    </div>
                                    <div className="hidden lg:block p-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 text-sm text-gray-500"><p className="mb-2 font-semibold">Quick Tips:</p><ul className="list-disc pl-4 space-y-1"><li>Click time slot to add.</li><li>Click task to edit/done.</li><li>Arrow keys for days.</li></ul></div>
                                </div>
                            </div>
                        )}
                    </main>

                    <Modal isOpen={isEntryModalOpen} onClose={() => setIsEntryModalOpen(false)} title={editingEntry?.id ? 'Edit Block' : 'New Time Block'}>
                        <form onSubmit={(e) => {
                            e.preventDefault(); const fd = new FormData(e.target);
                            const entry = { id: editingEntry?.id, title: fd.get('title'), description: fd.get('description'), date: fd.get('date'), startTime: fd.get('startTime'), duration: parseInt(fd.get('duration')), status: editingEntry?.status || 'planned', color: fd.get('color') };
                            editingEntry?.id ? updateEntry(entry) : addEntry(entry);
                        }} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Task Title</label><input name="title" defaultValue={editingEntry?.title} autoFocus className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="What are you doing?" required /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label><input type="date" name="date" defaultValue={editingEntry?.date} className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time</label><input type="time" name="startTime" defaultValue={editingEntry?.startTime} className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" required /></div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (min)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" name="duration" defaultValue={editingEntry?.duration} min="15" step="15" className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" />
                                    <div className="flex gap-1">{[15, 30, 60, 90].map(m => <button key={m} type="button" onClick={(e) => { e.currentTarget.closest('div').previousElementSibling.value = m; }} className="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-800 rounded hover:bg-gray-200 dark:hover:bg-gray-700">{m}m</button>)}</div>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color Tag</label>
                                <div className="flex gap-3">
                                    {['blue', 'green', 'purple', 'orange', 'gray'].map(color => {
                                        // FIXED: Explicit color classes for Tailwind CDN
                                        const colorMap = { blue: 'bg-blue-500', green: 'bg-green-500', purple: 'bg-purple-500', orange: 'bg-orange-500', gray: 'bg-gray-500' };
                                        return (
                                            <label key={color} className="cursor-pointer relative">
                                                <input type="radio" name="color" value={color} defaultChecked={(editingEntry?.color || 'blue') === color} className="peer sr-only" />
                                                <div className={`w-8 h-8 rounded-full ${colorMap[color]} peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-500 dark:ring-offset-gray-900 hover:scale-110 transition-transform`}></div>
                                            </label>
                                        )
                                    })}
                                </div>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label><textarea name="description" defaultValue={editingEntry?.description} rows="3" className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea></div>
                            <div className="flex gap-3 pt-2">
                                {editingEntry?.id && <Button type="button" variant="danger" onClick={() => deleteEntry(editingEntry.id)} className="mr-auto"><TrashIcon size={18} /></Button>}
                                <Button type="button" variant="secondary" onClick={() => setIsEntryModalOpen(false)}>Cancel</Button>
                                <Button type="submit">Save</Button>
                            </div>
                        </form>
                    </Modal>

                    <Modal isOpen={showSearch} onClose={() => { setShowSearch(false); setSearchQuery(''); }} title="Search Entries">
                        <div className="space-y-4">
                            <div className="relative"><span className="absolute left-3 top-2.5 text-gray-400"><SearchIcon size={20} /></span><input autoFocus type="text" placeholder="Type to search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                            <div className="max-h-60 overflow-y-auto space-y-2">
                                {searchQuery && filteredEntries.length === 0 && <div className="text-center text-gray-500 py-4">No results found.</div>}
                                {filteredEntries.map(entry => (
                                    <div key={entry.id} onClick={() => { setCurrentDate(new Date(entry.date)); setView('day'); setShowSearch(false); setSearchQuery(''); }} className="p-3 rounded-lg border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors group">
                                        <div className="flex justify-between items-start"><span className="font-semibold">{entry.title}</span><span className="text-xs text-gray-400 group-hover:text-blue-500">{entry.date}</span></div>
                                        <div className="text-sm text-gray-500 flex gap-2 mt-1">
                                            <span className={`px-1.5 py-0.5 rounded text-[10px] uppercase tracking-wide font-bold ${entry.status === 'done' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{entry.status}</span>
                                            <span>{entry.startTime} ({entry.duration}m)</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TimeBlocks />);
    </script>
</body>
</html>


