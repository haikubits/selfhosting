<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Collage Studio</title>
    <style>
        :root {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --bg-canvas: #000000;
            --border: #333;
            --accent: #3b82f6;
            --text: #fff;
            --text-muted: #888;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 50px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-panel);
            z-index: 20;
            flex-shrink: 0;
        }
        
        .logo { font-weight: 600; display:flex; gap:10px; align-items:center; }
        
        .header-actions { display: flex; gap: 8px; }
        
        button { cursor: pointer; font-family: inherit; }
        
        .btn-icon {
            background: none; border: 1px solid var(--border); color: var(--text);
            width: 36px; height: 36px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .btn-icon:hover { background: #333; }
        
        .btn-primary {
            background: var(--accent); color: white; border: none;
            padding: 0 16px; height: 36px; border-radius: 20px;
            font-weight: 600; font-size: 14px;
        }
        .btn-primary:active { opacity: 0.8; }

        /* --- MAIN LAYOUT --- */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* WORKSPACE (Canvas) */
        .workspace {
            flex: 1;
            background: var(--bg-canvas);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        #collage-area {
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: width 0.3s, height 0.3s;
            position: relative;
        }

        .frame {
            position: absolute;
            overflow: hidden;
            background: #ddd;
        }
        .frame.selected { z-index: 10; }
        .frame.selected::after {
            content:''; position: absolute; inset:0;
            border: 2px solid var(--accent); pointer-events: none;
        }
        .frame img {
            position: absolute; top:50%; left:50%;
            pointer-events: none;
            /* Ensure cover logic in preview */
            min-width: 100%; min-height: 100%;
            object-fit: cover; 
            transform-origin: center;
        }

        /* SIDEBAR / BOTTOM SHEET */
        .controls-panel {
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
            z-index: 15;
            border-left: 1px solid var(--border);
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid transparent;
            background: none; border-top: none; border-left: none; border-right: none;
        }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(255,255,255,0.03);
        }

        /* Tab Content Areas */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }
        .tab-content.active { display: block; }

        /* UI Elements */
        .section-title {
            font-size: 11px; text-transform: uppercase; color: var(--text-muted);
            margin: 0 0 10px 0; font-weight: 700; letter-spacing: 1px;
        }
        
        .control-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px; gap: 10px;
        }
        
        label { font-size: 13px; color: var(--text); }
        
        input[type="range"] {
            flex: 1; height: 4px; background: #444;
            appearance: none; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 18px; height: 18px;
            background: var(--text); border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        select, input[type="color"] {
            background: #333; color: white; border: 1px solid #444;
            height: 30px; border-radius: 4px; padding: 0 5px;
        }

        /* Grids */
        .grid { display: grid; gap: 8px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }

        .thumb-btn {
            aspect-ratio: 1; background: #333; border: 1px solid #444;
            border-radius: 4px; cursor: pointer; overflow: hidden; position: relative;
        }
        .thumb-btn img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-btn svg { width: 100%; height: 100%; fill: #666; padding: 5px; }
        .thumb-btn:hover { border-color: var(--accent); }

        .add-photo-btn {
            background: #222; border: 2px dashed #444; color: #888;
            border-radius: 8px; padding: 20px; text-align: center;
            margin-bottom: 20px; cursor: pointer;
        }

        /* Handles */
        .resize-handle {
            position: absolute; width: 20px; height: 20px;
            background: var(--accent); border: 2px solid white; border-radius: 50%;
            z-index: 20; transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .h-n { top: 0; left: 50%; }
        .h-s { top: 100%; left: 50%; }
        .h-w { top: 50%; left: 0; }
        .h-e { top: 50%; left: 100%; }

        /* RESPONSIVE LOGIC */
        /* Desktop */
        @media (min-width: 769px) {
            .app-container { flex-direction: row; }
            .controls-panel { width: 320px; height: 100%; }
            .tabs { order: -1; } /* Tabs at top */
        }

        /* Mobile */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .workspace { height: 55%; border-bottom: 1px solid var(--border); }
            .controls-panel { height: 45%; border-left: none; width: 100%; }
            .tabs { order: -1; } /* Tabs at top of panel */
            
            /* Increase touch targets */
            .tab { padding: 15px 5px; font-size: 11px; } 
            input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
        }

        /* Landscape Mobile */
        @media (max-width: 850px) and (orientation: landscape) {
             .app-container { flex-direction: row; }
             .workspace { height: 100%; width: auto; }
             .controls-panel { width: 300px; height: 100%; }
        }
        
        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); padding: 15px 25px; border-radius: 30px;
            color: white; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
        <span>Collage Studio</span>
    </div>
    <div class="header-actions">
        <button class="btn-icon" onclick="app.undo()" title="Undo">↶</button>
        <button class="btn-icon" onclick="app.redo()" title="Redo">↷</button>
        <button class="btn-primary" onclick="app.exportCollage()">Save</button>
    </div>
</header>

<div class="app-container">
    <div class="workspace" id="workspace">
        <div id="collage-area"></div>
    </div>

    <div class="controls-panel">
        <div class="tabs">
            <button id="btn-tab-photos" class="tab active" onclick="app.setTab('photos')">Photos</button>
            <button id="btn-tab-layout" class="tab" onclick="app.setTab('layout')">Layout</button>
            <button id="btn-tab-edit" class="tab" onclick="app.setTab('edit')">Edit</button>
            <button id="btn-tab-canvas" class="tab" onclick="app.setTab('canvas')">Canvas</button>
        </div>

        <!-- PHOTOS TAB -->
        <div id="tab-photos" class="tab-content active">
            <div class="add-photo-btn" onclick="document.getElementById('file-input').click()">
                <span>+ Tap to Add Photos</span>
            </div>
            <input type="file" id="file-input" multiple accept="image/*" style="display:none">
            <h4 class="section-title">Your Library</h4>
            <div class="grid grid-3" id="photo-tray"></div>
        </div>

        <!-- LAYOUT TAB -->
        <div id="tab-layout" class="tab-content">
            <h4 class="section-title">Templates</h4>
            <div class="grid grid-3" id="template-list"></div>
        </div>

        <!-- EDIT TAB -->
        <div id="tab-edit" class="tab-content">
            <div id="msg-no-sel" style="text-align:center; margin-top:40px; color:#666;">
                Tap a photo frame to edit
            </div>
            <div id="controls-sel" style="display:none;">
                <h4 class="section-title">Image Transform</h4>
                <div class="control-row">
                    <label>Zoom</label>
                    <input type="range" id="inp-zoom" min="0.1" max="3" step="0.1" oninput="app.updateImage('zoom', this.value)">
                </div>
                <div class="control-row">
                    <label>Rotate</label>
                    <input type="range" id="inp-rot" min="-180" max="180" step="90" oninput="app.updateImage('rotate', this.value)">
                </div>
                <div class="grid grid-2" style="margin-bottom:20px;">
                    <button class="btn-icon" style="width:100%; border-radius:4px; font-size:12px;" onclick="app.fitImage()">Fit</button>
                    <button class="btn-icon" style="width:100%; border-radius:4px; font-size:12px; color:#f87171; border-color:#7f1d1d;" onclick="app.clearImage()">Clear</button>
                </div>

                <h4 class="section-title">Frame Style</h4>
                <div class="control-row">
                    <label>Roundness</label>
                    <input type="range" id="inp-br" min="0" max="50" oninput="app.updateFrame('br', this.value)">
                </div>
                <div class="control-row">
                    <label>Border</label>
                    <input type="range" id="inp-bw" min="0" max="20" oninput="app.updateFrame('bw', this.value)">
                </div>
                <div class="control-row">
                    <label>Color</label>
                    <input type="color" id="inp-bc" onchange="app.updateFrame('bc', this.value)">
                </div>
            </div>
        </div>

        <!-- CANVAS TAB -->
        <div id="tab-canvas" class="tab-content">
            <h4 class="section-title">Dimensions</h4>
            <div class="control-row">
                <label>Aspect Ratio</label>
                <select id="inp-ratio" onchange="app.updateCanvas('ratio', this.value)" style="width:120px;">
                    <option value="1:1">1:1 Square</option>
                    <option value="4:5">4:5 Portrait</option>
                    <option value="9:16">9:16 Story</option>
                    <option value="3:4">3:4 Photo</option>
                    <option value="16:9">16:9 Cinema</option>
                    <option value="1.414">A4 Paper</option>
                </select>
            </div>
            
            <h4 class="section-title">Spacing</h4>
            <div class="control-row">
                <label>Gap</label>
                <input type="range" id="inp-gap" min="0" max="50" oninput="app.updateCanvas('gap', this.value)">
            </div>
            <div class="control-row">
                <label>Padding</label>
                <input type="range" id="inp-pad" min="0" max="100" oninput="app.updateCanvas('pad', this.value)">
            </div>
            <div class="control-row">
                <label>Background</label>
                <input type="color" id="inp-bg" onchange="app.updateCanvas('bg', this.value)">
            </div>
            
            <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <button class="btn-primary" style="background:#222; border:1px solid #d32f2f; color:#ef5350; width:100%;" onclick="app.reset()">Reset Project</button>
            </div>
        </div>
    </div>
</div>

<div id="toast">Saved!</div>

<script>
const TEMPLATES = {
    'grid-1': [{x:0,y:0,w:100,h:100}],
    'grid-2v': [{x:0,y:0,w:50,h:100}, {x:50,y:0,w:50,h:100}],
    'grid-2h': [{x:0,y:0,w:100,h:50}, {x:0,y:50,w:100,h:50}],
    'grid-3': [{x:0,y:0,w:50,h:100}, {x:50,y:0,w:50,h:50}, {x:50,y:50,w:50,h:50}],
    'grid-4': [{x:0,y:0,w:50,h:50}, {x:50,y:0,w:50,h:50}, {x:0,y:50,w:50,h:50}, {x:50,y:50,w:50,h:50}],
    'grid-6': [{x:0,y:0,w:33.3,h:50},{x:33.3,y:0,w:33.3,h:50},{x:66.6,y:0,w:33.3,h:50},{x:0,y:50,w:33.3,h:50},{x:33.3,y:50,w:33.3,h:50},{x:66.6,y:50,w:33.3,h:50}],
};

class App {
    constructor() {
        this.data = {
            canvas: { ratio: '1:1', gap: 5, padding: 20, bg: '#ffffff' },
            frames: [],
            images: {},
            sel: null
        };
        this.history = [];
        this.histIdx = -1;
        this.drag = null;

        this.els = {
            ws: document.getElementById('workspace'),
            area: document.getElementById('collage-area'),
            fileInput: document.getElementById('file-input'),
            tray: document.getElementById('photo-tray')
        };
        
        this.init();
    }

    init() {
        // Load Data
        const saved = localStorage.getItem('cs_data');
        if(saved) {
            try { this.data = JSON.parse(saved); } catch(e){}
        } else {
            this.loadTemplate('grid-4', false);
        }

        this.renderTemplates();
        this.setupEvents();
        this.render();
        
        // Mobile check to set initial tab
        if(window.innerWidth < 768) this.setTab('photos');
        else this.setTab('photos');
    }

    setupEvents() {
        this.els.fileInput.onchange = (e) => this.addPhotos(e.target.files);
        
        // Global pointer events for dragging
        document.addEventListener('pointermove', this.onMove.bind(this));
        document.addEventListener('pointerup', this.onUp.bind(this));
        
        // Prevent default touch actions on workspace
        this.els.area.addEventListener('pointerdown', (e) => {
            // If clicking background (not frame), deselect
            if(e.target === this.els.area) this.select(null);
        });
    }

    /* --- TABS --- */
    setTab(id) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`btn-tab-${id}`).classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
    }

    /* --- HISTORY --- */
    pushHist() {
        if(this.histIdx < this.history.length - 1) {
            this.history = this.history.slice(0, this.histIdx + 1);
        }
        this.history.push(JSON.stringify(this.data));
        if(this.history.length > 20) this.history.shift();
        else this.histIdx++;
        
        this.saveLS();
    }

    undo() {
        if(this.histIdx > 0) {
            this.histIdx--;
            this.data = JSON.parse(this.history[this.histIdx]);
            this.render();
            this.syncUI();
        }
    }

    redo() {
        if(this.histIdx < this.history.length - 1) {
            this.histIdx++;
            this.data = JSON.parse(this.history[this.histIdx]);
            this.render();
            this.syncUI();
        }
    }

    saveLS() {
        localStorage.setItem('cs_data', JSON.stringify(this.data));
    }
    
    reset() {
        if(confirm("Reset Project?")) {
            this.data.images = {};
            this.loadTemplate('grid-4');
        }
    }

    /* --- LOGIC --- */
    async addPhotos(files) {
        for(let file of files) {
            if(!file.type.startsWith('image')) continue;
            const bmp = await createImageBitmap(file);
            
            // Downscale
            let w = bmp.width, h = bmp.height;
            const max = 1500;
            if(w > max || h > max) {
                const s = max / Math.max(w,h);
                w *= s; h *= s;
            }
            
            const cvs = document.createElement('canvas');
            cvs.width = w; cvs.height = h;
            cvs.getContext('2d').drawImage(bmp,0,0,w,h);
            const url = cvs.toDataURL('image/jpeg', 0.85);
            
            const id = 'img_'+Math.random().toString(36).substr(2);
            this.data.images[id] = url;
            
            // Auto-fill
            const empty = this.data.frames.find(f => !f.imgId);
            if(empty) {
                empty.imgId = id;
                empty.pan = {x:0, y:0};
                empty.zoom = 1;
                empty.rot = 0;
            }
        }
        this.pushHist();
        this.render();
    }

    loadTemplate(key, save=true) {
        if(save) this.pushHist();
        const tpl = TEMPLATES[key];
        const oldFrames = this.data.frames || [];
        
        this.data.frames = tpl.map((box, i) => {
            const old = oldFrames[i] || {};
            return {
                id: i,
                x: box.x, y: box.y, w: box.w, h: box.h,
                // Inherit image or null
                imgId: old.imgId || null,
                pan: old.pan || {x:0, y:0},
                zoom: old.zoom || 1,
                rot: old.rot || 0,
                // Styles
                br: 0, bw: 0, bc: '#ffffff'
            };
        });
        this.render();
    }

    select(id) {
        this.data.sel = id;
        this.render(); // Redraw handles
        this.syncUI();
        if(id !== null && window.innerWidth < 768) this.setTab('edit');
    }

    /* --- UPDATES --- */
    updateCanvas(key, val) {
        if(key === 'ratio') this.data.canvas.ratio = val;
        if(key === 'gap') this.data.canvas.gap = parseInt(val);
        if(key === 'pad') this.data.canvas.padding = parseInt(val);
        if(key === 'bg') this.data.canvas.bg = val;
        this.render();
        // Debounce history? For now push on cha
