<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LocalChat WebAI</title>
    
    <!-- 1. GLOBAL ERROR HANDLER -->
    <style>
        #fatal-error { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; color: red; font-family: monospace; border: 4px solid red; overflow: auto; }
    </style>
    <div id="fatal-error"></div>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes("ResizeObserver")) return;
            const div = document.getElementById('fatal-error');
            div.style.display = 'block';
            div.innerHTML = `<h3>Critical App Error</h3><p>${msg}</p><p>Location: ${url}:${line}:${col}</p><pre>${error ? error.stack : 'No stack trace'}</pre><button onclick="window.location.reload()" style="padding:10px; margin-top:10px; border:1px solid #ccc; cursor:pointer;">Reload App</button>`;
        };
    </script>

    <!-- 2. STYLING (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { primary: '#2563eb' } }
            }
        }
    </script>

    <!-- 3. UTILS (Marked & Lucide) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .prose pre { background-color: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { background-color: rgba(100, 116, 139, 0.2); padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .mobile-height { height: 100dvh; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-200 mobile-height flex flex-col overflow-hidden font-sans">

    <!-- OVERLAY (Loading / Errors) -->
    <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-slate-700">
            <h3 id="overlay-title" class="text-lg font-bold mb-2">Processing...</h3>
            <p id="overlay-msg" class="text-sm text-slate-600 dark:text-slate-300 mb-4">Initializing environment.</p>
            
            <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-4 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <div id="overlay-actions" class="hidden flex flex-col gap-2">
                <p class="text-xs text-red-500 mb-2 font-mono bg-red-50 dark:bg-red-900/20 p-2 rounded" id="error-details">Unknown Error</p>
                <button id="btn-force-wasm" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                    Switch to CPU Mode (WASM)
                </button>
                <button id="overlay-close" class="w-full py-2 px-4 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors">
                    Dismiss
                </button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-14 border-b border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <i data-lucide="cpu" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
            <h1 class="font-bold text-lg tracking-tight hidden sm:block">LocalChat WebAI</h1>
            <h1 class="font-bold text-lg tracking-tight sm:hidden">LocalChat</h1>
            <span id="mode-badge" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 dark:bg-slate-800 text-gray-600 dark:text-slate-400 font-mono">...</span>
        </div>
        
        <div class="flex items-center gap-1 sm:gap-2">
            <div class="hidden md:flex items-center gap-2 mr-2">
                <select id="model-select" class="text-sm bg-gray-100 dark:bg-slate-800 border-none rounded-lg py-1.5 px-3 focus:ring-1 focus:ring-blue-500 max-w-[200px] truncate"></select>
                <button id="btn-load-model" class="text-xs font-semibold bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition-colors">Load</button>
            </div>
            <button id="btn-reset" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
            <button id="btn-theme" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg"><i data-lucide="sun-moon" class="w-5 h-5"></i></button>
            <button id="btn-settings" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg md:hidden"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <button id="btn-export-ui" class="hidden md:block p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg"><i data-lucide="download" class="w-5 h-5"></i></button>
        </div>
    </header>

    <!-- MAIN APP -->
    <main class="flex-1 flex overflow-hidden relative">
        <div class="flex-1 flex flex-col relative w-full max-w-4xl mx-auto">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth pb-32">
                <div id="welcome-screen" class="flex flex-col gap-2 items-center justify-center h-full text-center text-slate-400 p-8">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center mb-4">
                        <i data-lucide="message-square" class="w-8 h-8 text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">Browser-Based AI</h2>
                    <p class="max-w-md text-sm">Runs locally using WebGPU or WASM.<br>First load downloads model weights (1GB+).</p>
                    <div class="mt-6 w-full max-w-xs md:hidden flex flex-col gap-2">
                        <select id="model-select-mobile" class="w-full text-sm bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg py-2 px-3"></select>
                        <button id="btn-load-model-mobile" class="w-full bg-blue-600 text-white font-medium py-2 rounded-lg">Load Model</button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent dark:from-slate-950 dark:via-slate-950 pt-10">
                <div class="relative max-w-3xl mx-auto shadow-lg rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 focus-within:ring-2 focus-within:ring-blue-500/50 transition-all">
                    <textarea id="user-input" rows="1" class="w-full bg-transparent text-slate-900 dark:text-slate-100 placeholder-slate-400 px-4 py-3.5 pr-12 resize-none focus:outline-none max-h-48 rounded-2xl" placeholder="Type a message..."></textarea>
                    <button id="btn-send" disabled class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-stop" class="hidden absolute right-14 bottom-2 p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors"><i data-lucide="square" class="w-5 h-5 fill-current"></i></button>
                </div>
                <div class="text-center mt-2 flex justify-center items-center gap-2">
                    <p class="text-[10px] text-slate-400 dark:text-slate-600">AI can make mistakes.</p>
                </div>
            </div>
        </div>

        <!-- SETTINGS DRAWER -->
        <div id="settings-drawer" class="absolute inset-y-0 right-0 w-80 bg-white dark:bg-slate-900 shadow-2xl transform translate-x-full transition-transform duration-300 z-30 border-l border-gray-200 dark:border-slate-800 flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between">
                <h2 class="font-bold">Settings</h2>
                <button id="btn-close-settings" class="p-1 hover:bg-gray-100 dark:hover:bg-slate-800 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 space-y-6 overflow-y-auto flex-1">
                
                <!-- NEW: MODE TOGGLE -->
                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Runtime Mode</h3>
                    <div class="flex bg-gray-100 dark:bg-slate-800 p-1 rounded-lg border border-gray-200 dark:border-slate-700">
                        <button id="btn-mode-gpu" class="flex-1 py-1.5 text-xs font-medium rounded-md transition-all">WebGPU</button>
                        <button id="btn-mode-wasm" class="flex-1 py-1.5 text-xs font-medium rounded-md transition-all">CPU (WASM)</button>
                    </div>
                    <p id="gpu-warning" class="text-[10px] text-red-500 mt-1 hidden">WebGPU not detected on this device.</p>
                </div>
                <hr class="border-gray-100 dark:border-slate-800">

                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Model Cache</h3>
                    <div id="cache-list" class="space-y-2 text-sm text-slate-400 italic">None.</div>
                    <button id="btn-clear-cache" class="mt-2 w-full flex items-center justify-center gap-2 px-3 py-2 text-xs text-red-600 bg-red-50 dark:bg-red-900/20 rounded-lg"><i data-lucide="trash" class="w-3 h-3"></i> Clear Cache</button>
                </div>
                <hr class="border-gray-100 dark:border-slate-800">
                <div class="space-y-2">
                    <button id="btn-export" class="w-full flex items-center gap-2 px-3 py-2 text-sm bg-gray-100 dark:bg-slate-800 rounded-lg"><i data-lucide="download" class="w-4 h-4"></i> Export Chat</button>
                    <label class="w-full flex items-center gap-2 px-3 py-2 text-sm bg-gray-100 dark:bg-slate-800 rounded-lg cursor-pointer">
                        <i data-lucide="upload" class="w-4 h-4"></i> Import Chat
                        <input type="file" id="file-import" class="hidden" accept=".json">
                    </label>
                    <button id="btn-clear-history" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 bg-red-50 dark:bg-red-900/20 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i> Clear History</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 4. LOGIC (Module) -->
    <script type="module">
        // --- 1. CONFIG & DATA ---
        const MODELS = {
            gpu: [
                { id: "Llama-3.2-1B-Instruct-q4f16_1-MLC", name: "Llama 3.2 1B (GPU)" },
                { id: "Phi-3.5-mini-instruct-q4f16_1-MLC", name: "Phi 3.5 Mini (GPU)" },
                { id: "Qwen2.5-1.5B-Instruct-q4f16_1-MLC", name: "Qwen 2.5 1.5B (GPU)" }
            ],
            wasm: [
                { id: "Xenova/TinyLlama-1.1B-Chat-v1.0", name: "TinyLlama 1.1B (CPU)" },
                { id: "Xenova/Qwen1.5-0.5B-Chat", name: "Qwen 1.5 0.5B (CPU)" },
                { id: "Xenova/flan-t5-small", name: "Flan T5 (CPU)" }
            ]
        };

        const STATE = {
            messages: [],
            prefs: { theme: 'system', mode: 'detect', modelId: '', downloadedModels: [] },
            runtime: { engine: null, worker: null, type: null, status: 'idle' }
        };

        // DOM Cache
        const $ = id => document.getElementById(id);
        const el = {
            app: document.documentElement,
            msgContainer: $('chat-container'),
            welcome: $('welcome-screen'),
            input: $('user-input'),
            btnSend: $('btn-send'),
            btnStop: $('btn-stop'),
            btnReset: $('btn-reset'),
            btnTheme: $('btn-theme'),
            btnSettings: $('btn-settings'),
            btnCloseSettings: $('btn-close-settings'),
            drawer: $('settings-drawer'),
            modelSelect: $('model-select'),
            modelSelectMobile: $('model-select-mobile'),
            btnLoad: $('btn-load-model'),
            btnLoadMobile: $('btn-load-model-mobile'),
            overlay: $('overlay'),
            overlayMsg: $('overlay-msg'),
            progress: $('progress-bar'),
            progressContainer: $('progress-container'),
            overlayActions: $('overlay-actions'),
            errorDetails: $('error-details'),
            btnForceWasm: $('btn-force-wasm'),
            modeBadge: $('mode-badge'),
            cacheList: $('cache-list'),
            // New Mode Toggles
            btnModeGpu: $('btn-mode-gpu'),
            btnModeWasm: $('btn-mode-wasm'),
            gpuWarning: $('gpu-warning')
        };

        // --- 2. STARTUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            loadLocalState();
            applyTheme();

            // Detect GPU Support
            const hasGPU = !!navigator.gpu;
            
            // If user hasn't explicitly set a preference, or if their preference is invalid (gpu on non-gpu device), auto-detect
            if (!STATE.prefs.mode || (STATE.prefs.mode === 'gpu' && !hasGPU)) {
                STATE.prefs.mode = hasGPU ? 'gpu' : 'wasm';
            }

            // Init Mode UI
            renderModeSelector(hasGPU);
            updateModeUI();

            refreshModelDropdowns();
            renderMessages();
            setupListeners();
        });

        // --- 3. CORE LOGIC ---
        
        async function initWebLLM(modelId) {
            updateOverlay(true, "Initializing WebGPU Engine...", 0);
            
            if (STATE.runtime.worker) {
                STATE.runtime.worker.terminate();
                STATE.runtime.worker = null;
            }

            const { CreateWebWorkerMLCEngine } = await import("https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.78/+esm");

            const workerCode = `
                import { WebWorkerMLCEngineHandler } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.78/+esm";
                const h = new WebWorkerMLCEngineHandler();
                self.onmessage = (e) => h.onmessage(e);
            `;
            const blob = new Blob([workerCode], { type: "text/javascript" });
            const worker = new Worker(URL.createObjectURL(blob), { type: "module" });
            STATE.runtime.worker = worker;

            return await CreateWebWorkerMLCEngine(worker, modelId, {
                initProgressCallback: (r) => {
                    const p = r.progress * 100;
                    updateOverlay(true, r.text, p);
                }
            });
        }

        async function initWASM(modelId) {
            updateOverlay(true, "Initializing CPU Engine...", 0);
            
            const { pipeline, env } = await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js");
            
            env.allowLocalModels = false;
            env.useBrowserCache = true;

            return await pipeline("text-generation", modelId, {
                device: "wasm",
                dtype: "q8",
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        const p = (data.loaded / data.total) * 100;
                        updateOverlay(true, `Downloading ${data.file}`, p);
                    }
                }
            });
        }

        // --- 4. ACTIONS & ERROR RECOVERY ---

        async function handleLoadModel() {
            const select = window.innerWidth < 768 ? el.modelSelectMobile : el.modelSelect;
            const modelId = select.value;
            if(!modelId) return alert("Select a model.");

            STATE.prefs.modelId = modelId;
            saveLocalState();

            el.overlayActions.classList.add('hidden');
            el.progressContainer.classList.remove('hidden');
            el.errorDetails.textContent = '';

            try {
                if (STATE.prefs.mode === 'gpu') {
                    STATE.runtime.engine = await initWebLLM(modelId);
                    STATE.runtime.type = 'gpu';
                } else {
                    STATE.runtime.engine = await initWASM(modelId);
                    STATE.runtime.type = 'wasm';
                }

                if (!STATE.prefs.downloadedModels.includes(modelId)) {
                    STATE.prefs.downloadedModels.push(modelId);
                    saveLocalState();
                    refreshModelDropdowns();
                }

                STATE.runtime.status = 'ready';
                updateOverlay(false);
                el.welcome.classList.add('hidden');
                el.btnSend.disabled = false;
                addSystemMessage(`Model Loaded (${STATE.runtime.type.toUpperCase()}). Ready.`);

            } catch (err) {
                console.error("Model Load Error:", err);
                const msg = err.message || err.toString();
                
                if (msg.includes("GPUPipelineError") || msg.includes("ShaderModule") || msg.includes("unlabeled")) {
                    updateOverlay(true, "GPU Incompatible. Switching to CPU...", 0);
                    setTimeout(() => switchMode('wasm', true), 1500); 
                    return;
                }

                updateOverlay(true, "Error Loading Model");
                el.progressContainer.classList.add('hidden');
                el.overlayActions.classList.remove('hidden');
                el.errorDetails.textContent = msg.slice(0, 100) + (msg.length > 100 ? "..." : "");
                
                if(STATE.prefs.mode === 'gpu') {
                    el.btnForceWasm.onclick = () => switchMode('wasm', false);
                    el.btnForceWasm.classList.remove('hidden');
                } else {
                    el.btnForceWasm.classList.add('hidden');
                }
            }
        }

        function switchMode(newMode, autoLoad = false) {
            STATE.prefs.mode = newMode;
            saveLocalState();
            
            renderModeSelector(!!navigator.gpu);
            updateModeUI();
            refreshModelDropdowns();
            
            if (autoLoad) {
                const fallbackModel = MODELS.wasm[0].id;
                el.modelSelect.value = fallbackModel;
                el.modelSelectMobile.value = fallbackModel;
                handleLoadModel();
            } else {
                updateOverlay(false);
                alert(`Switched to ${newMode === 'gpu' ? 'WebGPU' : 'CPU'} Mode. Please select a model and click Load.`);
            }
        }

        async function handleSend() {
            const text = el.input.value.trim();
            if(!text) return;
            if(STATE.runtime.status !== 'ready') return alert("Load a model first.");

            addMessage('user', text);
            el.input.value = '';
            el.input.style.height = 'auto';
            const botMsgId = addMessage('assistant', '');
            
            STATE.runtime.status = 'generating';
            el.btnSend.classList.add('hidden');
            el.btnStop.classList.remove('hidden');

            const context = buildContext();
            let fullText = "";

            try {
                if (STATE.runtime.type === 'gpu') {
                    const completion = await STATE.runtime.engine.chat.completions.create({
                        messages: context,
                        stream: true,
                        max_tokens: 1024,
                        temperature: 0.7
                    });
                    for await (const chunk of completion) {
                        const delta = chunk.choices[0].delta.content;
                        if (delta) {
                            fullText += delta;
                            updateMessageContent(botMsgId, fullText);
                        }
                    }
                } else {
                    const prompt = context.map(m => `${m.role}:${m.content}`).join('\n') + "\nassistant:";
                    const out = await STATE.runtime.engine(prompt, { max_new_tokens: 256, do_sample: true });
                    let raw = out[0].generated_text;
                    fullText = raw.substring(prompt.length) || raw;
                    updateMessageContent(botMsgId, fullText);
                }
            } catch (e) {
                updateMessageContent(botMsgId, fullText + `\n\n[Error: ${e.message}]`);
            }

            STATE.runtime.status = 'ready';
            el.btnSend.classList.remove('hidden');
            el.btnStop.classList.add('hidden');
            saveLocalState();
        }

        // --- 5. HELPERS & UI ---

        function renderModeSelector(hasGPU) {
            const isGPU = STATE.prefs.mode === 'gpu';
            
            // Button Styles
            const activeClass = "bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-300 shadow-sm";
            const inactiveClass = "text-slate-500 hover:text-slate-700 dark:hover:text-slate-300";

            el.btnModeGpu.className = `flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${isGPU ? activeClass : inactiveClass}`;
            el.btnModeWasm.className = `flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${!isGPU ? activeClass : inactiveClass}`;

            // Hardware Check
            if (!hasGPU) {
                el.btnModeGpu.disabled = true;
                el.btnModeGpu.classList.add('opacity-50', 'cursor-not-allowed');
                el.gpuWarning.classList.remove('hidden');
            } else {
                el.btnModeGpu.disabled = false;
                el.gpuWarning.classList.add('hidden');
            }
        }

        function updateModeUI() {
            const isGPU = STATE.prefs.mode === 'gpu';
            el.modeBadge.textContent = isGPU ? 'WebGPU' : 'CPU (WASM)';
            el.modeBadge.className = `text-xs px-2 py-0.5 rounded-full font-mono border ${isGPU 
                ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 border-green-200' 
                : 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 border-orange-200'}`;
        }

        function updateOverlay(show, msg, p) {
            el.overlay.classList.toggle('hidden', !show);
            if(show) {
                el.overlayMsg.textContent = msg;
                if(p !== undefined) el.progress.style.width = `${p}%`;
            }
        }

        function addMessage(role, text) {
            const id = crypto.randomUUID();
            STATE.messages.push({ id, role, content: text });
            
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex w-full ${role === 'user' ? 'justify-end' : 'justify-start'} mb-6`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[75%] rounded-2xl px-4 py-3 shadow-sm ${
                role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-bl-none border border-gray-100 dark:border-slate-700'
            }`;
            
            const content = document.createElement('div');
            content.className = `prose ${role==='user'?'prose-invert':''} max-w-none text-sm break-words`;
            content.innerHTML = role === 'user' ? text.replace(/\n/g,'<br>') : marked.parse(text);
            
            bubble.appendChild(content);
            div.appendChild(bubble);
            el.msgContainer.appendChild(div);
            el.msgContainer.scrollTop = el.msgContainer.scrollHeight;
            
            el.welcome.classList.add('hidden');
            return id;
        }

        function updateMessageContent(id, text) {
            const msg = STATE.messages.find(m => m.id === id);
            if(msg) msg.content = text;
            const dom = document.getElementById(id);
            if(dom) dom.querySelector('.prose').innerHTML = marked.parse(text);
            el.msgContainer.scrollTop = el.msgContainer.scrollHeight;
        }

        function addSystemMessage(text) {
             const div = document.createElement('div');
             div.className = "flex justify-center my-4";
             div.innerHTML = `<span class="text-xs bg-gray-200 dark:bg-slate-800 text-gray-600 dark:text-slate-400 px-3 py-1 rounded-full border border-gray-300 dark:border-slate-700">${text}</span>`;
             el.msgContainer.appendChild(div);
        }

        function buildContext() {
            return [
                { role: "system", content: "You are a helpful assistant." },
                ...STATE.messages.slice(-10).map(m => ({ role: m.role, content: m.content }))
            ];
        }

        function refreshModelDropdowns() {
            const list = MODELS[STATE.prefs.mode];
            const populate = (sel) => {
                sel.innerHTML = `<option value="" disabled selected>Select Model (${STATE.prefs.mode.toUpperCase()})</option>`;
                list.forEach(m => {
                    const isCached = STATE.prefs.downloadedModels.includes(m.id);
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = isCached ? `âœ“ ${m.name}` : m.name;
                    if(m.id === STATE.prefs.modelId) opt.selected = true;
                    sel.appendChild(opt);
                });
            };
            populate(el.modelSelect);
            populate(el.modelSelectMobile);
            
            if(STATE.prefs.downloadedModels.length) {
                el.cacheList.innerHTML = STATE.prefs.downloadedModels.map(id => `<div class="flex items-center gap-2"><i data-lucide="check" class="w-3 h-3 text-green-500"></i> ${id}</div>`).join('');
                lucide.createIcons();
            } else {
                el.cacheList.innerHTML = `<div class="italic text-slate-400">None</div>`;
            }
        }

        function loadLocalState() {
            try {
                const data = JSON.parse(localStorage.getItem('localchat_v3'));
                if(data) {
                    STATE.messages = data.messages || [];
                    STATE.prefs = { ...STATE.prefs, ...data.prefs };
                    if(!Array.isArray(STATE.prefs.downloadedModels)) STATE.prefs.downloadedModels = [];
                }
            } catch(e) {}
        }
        
        function saveLocalState() {
            localStorage.setItem('localchat_v3', JSON.stringify({ messages: STATE.messages, prefs: STATE.prefs }));
        }

        function applyTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                el.app.classList.add('dark');
            } else {
                el.app.classList.remove('dark');
            }
        }

        function setupListeners() {
            el.btnLoad.onclick = handleLoadModel;
            el.btnLoadMobile.onclick = handleLoadModel;
            el.btnSend.onclick = handleSend;
            
            el.input.onkeydown = (e) => {
                if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
                el.input.style.height = 'auto';
                el.input.style.height = el.input.scrollHeight + 'px';
            };

            el.btnStop.onclick = () => window.location.reload();
            $('overlay-close').onclick = () => updateOverlay(false);
            
            el.btnSettings.onclick = () => el.drawer.classList.remove('translate-x-full');
            el.btnCloseSettings.onclick = () => el.drawer.classList.add('translate-x-full');
            
            el.btnTheme.onclick = () => {
                el.app.classList.toggle('dark');
                localStorage.theme = el.app.classList.contains('dark') ? 'dark' : 'light';
            };

            el.btnReset.onclick = () => {
                if(confirm("New Chat?")) {
                    STATE.messages = [];
                    saveLocalState();
                    renderMessages();
                    el.welcome.classList.remove('hidden');
                }
            };

            // Manual Mode Toggles
            el.btnModeGpu.onclick = () => switchMode('gpu', false);
            el.btnModeWasm.onclick = () => switchMode('wasm', false);

            $('btn-clear-cache').onclick = async () => {
                if(confirm("Delete all downloaded models?")) {
                    try {
                        const keys = await caches.keys();
                        for(const k of keys) await caches.delete(k);
                        STATE.prefs.downloadedModels = [];
                        saveLocalState();
                        alert("Cache cleared.");
                        window.location.reload();
                    } catch(e) { alert("Error clearing cache"); }
                }
            };

            $('btn-export').onclick = () => {
                const blob = new Blob([JSON.stringify(STATE)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `chat_export_${Date.now()}.json`;
                a.click();
            };
            
            $('file-import').onchange = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const d = JSON.parse(ev.target.result);
                            STATE.messages = d.messages;
                            STATE.prefs = {...STATE.prefs, ...d.prefs};
                            saveLocalState();
                            renderMessages();
                            refreshModelDropdowns();
                        } catch(err) { alert("Invalid File"); }
                    };
                    r.readAsText(f);
                }
            };
        }

        function renderMessages() {
            el.msgContainer.innerHTML = '';
            el.msgContainer.appendChild(el.welcome);
            if(STATE.messages.length > 0) el.welcome.classList.add('hidden');
            
            STATE.messages.forEach(m => {
                const div = document.createElement('div');
                div.id = m.id;
                div.className = `flex w-full ${m.role === 'user' ? 'justify-end' : 'justify-start'} mb-6`;
                const bubble = document.createElement('div');
                bubble.className = `max-w-[85%] md:max-w-[75%] rounded-2xl px-4 py-3 shadow-sm ${
                    m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-bl-none border border-gray-100 dark:border-slate-700'
                }`;
                const content = document.createElement('div');
                content.className = `prose ${m.role==='user'?'prose-invert':''} max-w-none text-sm break-words`;
                content.innerHTML = m.role === 'user' ? m.content.replace(/\n/g,'<br>') : marked.parse(m.content);
                bubble.appendChild(content);
                div.appendChild(bubble);
                el.msgContainer.appendChild(div);
            });
            el.msgContainer.scrollTop = el.msgContainer.scrollHeight;
        }
    </script>
</body>
</html>


