<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack - Secure Cloud</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Styles for Dark Mode scrollbars -->
    <style>
        body {
            background-color: #030712; /* gray-950 */
            color: #f3f4f6; /* gray-100 */
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * ------------------------------------------------------------------
         * CONFIGURATION SECTION
         * Paste your Firebase Project Config below to skip manual setup in the UI.
         * ------------------------------------------------------------------
         */
        const PRECONFIGURED_FIREBASE_CONFIG = {
            apiKey: "",            // e.g. "AIzaSy..."
            authDomain: "",        // e.g. "myapp.firebaseapp.com"
            projectId: "",         // e.g. "myapp-123"
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        /**
         * ICON COMPONENTS
         */
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const ChevronLeft = (props) => <Icon {...props}><polyline points="15 18 9 12 15 6" /></Icon>;
        const ChevronRight = (props) => <Icon {...props}><polyline points="9 18 15 12 9 6" /></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const Dumbbell = (props) => <Icon {...props}><path d="m6.5 6.5 11 11" /><path d="m21 21-1-1" /><path d="m3 3 1 1" /><path d="m18 22 4-4" /><path d="m2 6 4-4" /><path d="m3 10 7-7" /><path d="m14 21 7-7" /></Icon>;
        const Utensils = (props) => <Icon {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" /><path d="M7 2v20" /><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" /></Icon>;
        const Flame = (props) => <Icon {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.13.43-2.2 1.1-3a2.5 2.5 0 0 1 1.4 2.5z" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const Calculator = (props) => <Icon {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" y1="6" x2="16" y2="6" /><line x1="16" y1="14" x2="16" y2="14" /><line x1="12" y1="14" x2="12" y2="14" /><line x1="8" y1="14" x2="8" y2="14" /><line x1="16" y1="18" x2="16" y2="18" /><line x1="12" y1="18" x2="12" y2="18" /><line x1="8" y1="18" x2="8" y2="18" /></Icon>;
        const Cloud = (props) => <Icon {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M12 13.5v-3" /><path d="M12 7.5V5" /><path d="M12 5a7 7 0 0 1 7 7c0 2.22-.85 4.15-2.24 5.5" /><path d="M12 5a7 7 0 0 0-7 7c0 2.22.85 4.15 2.24 5.5" /></Icon>;
        const Lock = (props) => <Icon {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>;
        // Google Icon for Button
        const GoogleIcon = (props) => (
            <svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg" {...props}>
                <g transform="matrix(1, 0, 0, 1, 27.009001, -39.238998)">
                <path fill="#4285F4" d="M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z"/>
                <path fill="#34A853" d="M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.444 63.239 -14.754 63.239 Z"/>
                <path fill="#FBBC05" d="M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.724 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z"/>
                <path fill="#EA4335" d="M -14.754 43.989 C -12.984 43.989 -11.404 44.599 -10.154 45.789 L -6.734 42.369 C -8.804 40.429 -11.514 39.239 -14.754 39.239 C -19.444 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z"/>
                </g>
            </svg>
        );

        /**
         * CRYPTO & UTILITY FUNCTIONS
         */
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const formatDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };
        const formatDisplayDate = (dateString) => {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-').map(Number);
            return new Date(y, m - 1, d).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        };
        
        const DEFAULT_BMR = 1535;
        const calculateBMR = (gender, weight, height, age) => {
            if (!weight || !height || !age) return 0;
            const s = gender === 'male' ? 5 : -161;
            const result = (10 * Number(weight)) + (6.25 * Number(height)) - (5 * Number(age)) + s;
            return Math.round(result);
        };

        // --- CRYPTO UTILS ---
        const enc = new TextEncoder();
        const dec = new TextDecoder();

        const getPasswordKey = (password) => window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);

        const deriveKey = async (password, salt) => {
            const keyMaterial = await getPasswordKey(password);
            return window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: enc.encode(salt), iterations: 100000, hash: "SHA-256" },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        const encryptData = async (key, data) => {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encoded = enc.encode(JSON.stringify(data));
            const ciphertext = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);
            const combined = new Uint8Array(iv.length + ciphertext.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(ciphertext), iv.length);
            let binary = '';
            const len = combined.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(combined[i]);
            }
            return window.btoa(binary);
        }

        const decryptData = async (key, base64) => {
            const binaryStr = window.atob(base64);
            const len = binaryStr.length;
            const combined = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                combined[i] = binaryStr.charCodeAt(i);
            }
            
            const iv = combined.slice(0, 12);
            const ciphertext = combined.slice(12);
            const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
            return JSON.parse(dec.decode(decrypted));
        }


        /**
         * MAIN COMPONENT
         */
        function App() {
            // --- STATE ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDateKey, setSelectedDateKey] = useState(null);
            const [data, setData] = useState({});
            const [userSettings, setUserSettings] = useState({ 
                bmr: DEFAULT_BMR, gender: 'male', age: 31, weight: 70, height: 157 
            });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // --- CLOUD STATE ---
            const [firebaseConfig, setFirebaseConfig] = useState(null);
            const [isPreconfigured, setIsPreconfigured] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [syncPassphrase, setSyncPassphrase] = useState('');
            const [syncKey, setSyncKey] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            
            // Debounce ref for saving
            const saveTimeoutRef = useRef(null);

            // --- INITIALIZATION ---
            useEffect(() => {
                // 1. Load Local Data
                const savedData = localStorage.getItem('nutritrack_data');
                const savedSettings = localStorage.getItem('nutritrack_settings');
                if (savedData) setData(JSON.parse(savedData));
                if (savedSettings) setUserSettings(prev => ({ ...prev, ...JSON.parse(savedSettings) }));
                
                // 2. Load Config Strategy (Hardcoded vs LocalStorage)
                if (PRECONFIGURED_FIREBASE_CONFIG.apiKey) {
                    // Developer Mode: Use hardcoded config
                    setFirebaseConfig(PRECONFIGURED_FIREBASE_CONFIG);
                    setIsPreconfigured(true);
                    initFirebase(PRECONFIGURED_FIREBASE_CONFIG);
                } else {
                    // User Mode: Check local storage
                    const savedFbConfig = localStorage.getItem('nutritrack_fb_config');
                    if (savedFbConfig) {
                        const config = JSON.parse(savedFbConfig);
                        setFirebaseConfig(config);
                        initFirebase(config);
                    }
                }
            }, []);

            // --- PERSISTENCE (Save Local) ---
            useEffect(() => {
                localStorage.setItem('nutritrack_data', JSON.stringify(data));
                localStorage.setItem('nutritrack_settings', JSON.stringify(userSettings));
                
                if (currentUser && syncKey && syncStatus !== 'locked') {
                    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                    saveTimeoutRef.current = setTimeout(() => {
                        performCloudSync(data, userSettings);
                    }, 2000); // Debounce 2s
                }
            }, [data, userSettings]);

            // --- FIREBASE LOGIC ---
            const initFirebase = (config) => {
                if (!config || !config.apiKey) return;
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    firebase.auth().onAuthStateChanged((user) => {
                        setCurrentUser(user);
                        if (!user) {
                            setSyncKey(null);
                            setSyncStatus('idle');
                        } else {
                            setSyncStatus('locked'); 
                        }
                    });
                } catch (e) {
                    console.error("Firebase init error", e);
                }
            };

            const performCloudSync = async (currentData, currentSettings) => {
                if (!currentUser || !syncKey) return;
                setSyncStatus('syncing');
                try {
                    const db = firebase.firestore();
                    const encryptedData = await encryptData(syncKey, currentData);
                    const encryptedSettings = await encryptData(syncKey, currentSettings);
                    
                    await db.collection('users').doc(currentUser.uid).set({
                        data: encryptedData,
                        settings: encryptedSettings,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    setSyncStatus('success');
                    setTimeout(() => setSyncStatus('active'), 2000);
                } catch (e) {
                    console.error("Sync upload failed", e);
                    setSyncStatus('error');
                }
            };

            const handleUnlock = async () => {
                if (!syncPassphrase || !currentUser) return;
                setSyncStatus('syncing');
                
                try {
                    const db = firebase.firestore();
                    const docRef = db.collection('users').doc(currentUser.uid);
                    const doc = await docRef.get();
                    
                    let salt = 'default-salt';
                    if (doc.exists && doc.data().salt) {
                        salt = doc.data().salt;
                    } else if (!doc.exists) {
                        salt = generateId(); 
                        await docRef.set({ salt }, { merge: true });
                    }

                    const key = await deriveKey(syncPassphrase, salt);
                    setSyncKey(key);

                    if (doc.exists && doc.data().data) {
                        try {
                            const cloudData = await decryptData(key, doc.data().data);
                            const cloudSettings = await decryptData(key, doc.data().settings);
                            setData(cloudData);
                            setUserSettings(cloudSettings);
                            console.log("Decrypted data loaded from cloud");
                        } catch (decryptErr) {
                            alert("Incorrect Passphrase! Could not decrypt data.");
                            setSyncStatus('locked');
                            setSyncKey(null);
                            return;
                        }
                    } else {
                        performCloudSync(data, userSettings);
                    }
                    setSyncStatus('active');
                } catch (e) {
                    console.error("Unlock failed", e);
                    setSyncStatus('error');
                }
            };

            const handleSaveConfig = (newConfig) => {
                try {
                    const parsed = JSON.parse(newConfig);
                    setFirebaseConfig(parsed);
                    localStorage.setItem('nutritrack_fb_config', JSON.stringify(parsed));
                    initFirebase(parsed);
                } catch (e) {
                    alert("Invalid JSON configuration");
                }
            };

            const handleLogin = async (email, password, isSignup) => {
                try {
                    if (isSignup) {
                        await firebase.auth().createUserWithEmailAndPassword(email, password);
                    } else {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                    }
                } catch (e) {
                    alert(e.message);
                }
            };

            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await firebase.auth().signInWithPopup(provider);
                } catch (error) {
                    console.error("Google login error", error);
                    alert("Google Sign-In failed: " + error.message);
                }
            };

            // --- STANDARD HANDLERS ---
            const handlePrevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const jumpToToday = () => {
                const now = new Date();
                setCurrentDate(now);
                setSelectedDateKey(formatDateKey(now));
            };
            const updateEntry = (dateKey, section, items) => {
                setData(prev => ({ ...prev, [dateKey]: { ...prev[dateKey], [section]: items } }));
            };
            const getDayData = (day) => {
                const dateKey = formatDateKey(new Date(currentDate.getFullYear(), currentDate.getMonth(), day));
                const dayData = data[dateKey] || { foods: [], exercises: [] };
                const totalCaloriesIn = dayData.foods?.reduce((acc, curr) => acc + (Number(curr.calories) || 0), 0) || 0;
                const totalProtein = dayData.foods?.reduce((acc, curr) => acc + (Number(curr.protein) || 0), 0) || 0;
                const exerciseBurn = dayData.exercises?.reduce((acc, curr) => acc + (Number(curr.calories) || 0), 0) || 0;
                return { dateKey, totalCaloriesIn, totalProtein, exerciseBurn };
            };
            const handleAutoCalculateBMR = () => {
                const calculated = calculateBMR(userSettings.gender, userSettings.weight, userSettings.height, userSettings.age);
                if (calculated > 0) setUserSettings(prev => ({ ...prev, bmr: calculated }));
            };

            const renderCalendar = () => {
                const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
                const firstDay = getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth());
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-32 bg-gray-900/30 border border-gray-800/50"></div>);
                for (let d = 1; d <= daysInMonth; d++) {
                    const { dateKey, totalCaloriesIn, totalProtein, exerciseBurn } = getDayData(d);
                    const isToday = formatDateKey(new Date()) === dateKey;
                    const totalSpent = Number(userSettings.bmr) + exerciseBurn;
                    const net = totalCaloriesIn - totalSpent;
                    days.push(
                        <div key={dateKey} onClick={() => setSelectedDateKey(dateKey)} className={`h-32 p-2 border border-gray-800 bg-gray-900 hover:bg-gray-800 transition-colors cursor-pointer flex flex-col justify-between relative group ${isToday ? 'ring-1 ring-blue-500' : ''}`}>
                            <div className="flex justify-between items-start">
                                <span className={`text-sm font-medium ${isToday ? 'text-blue-400' : 'text-gray-400'}`}>{d}</span>
                                {totalCaloriesIn > 0 && (
                                    <span className={`text-xs px-1.5 rounded ${net > 0 ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`}>
                                        {net > 0 ? '+' : ''}{Math.round(net)}
                                    </span>
                                )}
                            </div>
                            <div className="space-y-1 mt-1">
                                {totalCaloriesIn > 0 && <div className="flex items-center text-xs text-emerald-400"><Utensils size={10} className="mr-1" />{Math.round(totalCaloriesIn)}</div>}
                                {totalProtein > 0 && <div className="flex items-center text-xs text-blue-400"><span className="font-bold text-[10px] mr-1">P</span>{Math.round(totalProtein)}g</div>}
                                <div className="flex items-center text-xs text-orange-400"><Flame size={10} className="mr-1" />{Math.round(totalSpent)}</div>
                            </div>
                        </div>
                    );
                }
                return days;
            };

            return (
                <div className="min-h-screen bg-gray-950 text-gray-100 font-sans selection:bg-blue-500/30">
                    <header className="border-b border-gray-800 p-4 sticky top-0 bg-gray-950/95 backdrop-blur z-10">
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <h1 className="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                                    <div className="w-8 h-8 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                                        <Utensils size={16} className="text-white" />
                                    </div>
                                    NutriTrack
                                </h1>
                                <div className="hidden md:flex items-center gap-1 bg-gray-900 rounded-lg p-1 border border-gray-800">
                                    <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-800 rounded"><ChevronLeft size={20} /></button>
                                    <span className="px-3 font-medium min-w-[140px] text-center">{currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                                    <button onClick={handleNextMonth} className="p-1 hover:bg-gray-800 rounded"><ChevronRight size={20} /></button>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {syncStatus === 'active' && <span className="text-xs text-emerald-500 font-medium px-2 py-1 bg-emerald-900/20 rounded flex items-center gap-1"><Lock size={10}/> Synced</span>}
                                {syncStatus === 'syncing' && <span className="text-xs text-blue-500 font-medium px-2 py-1 bg-blue-900/20 rounded">Syncing...</span>}
                                {syncStatus === 'locked' && <span className="text-xs text-orange-500 font-medium px-2 py-1 bg-orange-900/20 rounded flex items-center gap-1"><Lock size={10}/> Locked</span>}
                                <button onClick={jumpToToday} className="px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-md transition-colors">Today</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-gray-800 rounded-md text-gray-400 hover:text-white transition-colors relative">
                                    <Settings size={20} />
                                    {!firebaseConfig && <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4">
                        <div className="md:hidden flex justify-between items-center mb-4 text-lg font-medium">
                            <button onClick={handlePrevMonth}><ChevronLeft /></button>
                            <span>{currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={handleNextMonth}><ChevronRight /></button>
                        </div>
                        <div className="grid grid-cols-7 gap-px bg-gray-800 border border-gray-800 rounded-lg overflow-hidden shadow-2xl">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => <div key={day} className="bg-gray-900 p-2 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">{day}</div>)}
                            {renderCalendar()}
                        </div>
                    </main>

                    {selectedDateKey && <DayModal dateKey={selectedDateKey} data={data[selectedDateKey]} onClose={() => setSelectedDateKey(null)} onUpdate={(section, items) => updateEntry(selectedDateKey, section, items)} bmr={userSettings.bmr} />}

                    {isSettingsOpen && (
                        <SettingsModal 
                            userSettings={userSettings} 
                            setUserSettings={setUserSettings}
                            onClose={() => setIsSettingsOpen(false)}
                            onCalculateBMR={handleAutoCalculateBMR}
                            firebaseConfig={firebaseConfig}
                            isPreconfigured={isPreconfigured}
                            onSaveConfig={handleSaveConfig}
                            currentUser={currentUser}
                            onLogin={handleLogin}
                            onGoogleLogin={handleGoogleLogin}
                            onLogout={() => firebase.auth().signOut()}
                            syncPassphrase={syncPassphrase}
                            setSyncPassphrase={setSyncPassphrase}
                            onUnlock={handleUnlock}
                            syncStatus={syncStatus}
                        />
                    )}
                </div>
            );
        }

        /**
         * SETTINGS MODAL
         */
        function SettingsModal({ 
            userSettings, setUserSettings, onClose, onCalculateBMR,
            firebaseConfig, isPreconfigured, onSaveConfig, currentUser, onLogin, onGoogleLogin, onLogout,
            syncPassphrase, setSyncPassphrase, onUnlock, syncStatus 
        }) {
            const [activeTab, setActiveTab] = useState('profile');
            const [configInput, setConfigInput] = useState(firebaseConfig && !isPreconfigured ? JSON.stringify(firebaseConfig, null, 2) : '');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Settings size={20}/> Settings</h2>
                            <button onClick={onClose}><X className="text-gray-400 hover:text-white" /></button>
                        </div>

                        <div className="flex gap-2 mb-4 p-1 bg-gray-800 rounded-lg">
                            <button onClick={() => setActiveTab('profile')} className={`flex-1 py-1 text-sm font-medium rounded-md ${activeTab === 'profile' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'}`}>Profile</button>
                            <button onClick={() => setActiveTab('cloud')} className={`flex-1 py-1 text-sm font-medium rounded-md ${activeTab === 'cloud' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'}`}>Cloud Sync</button>
                        </div>
                        
                        <div className="overflow-y-auto flex-1 pr-2 space-y-6">
                            {activeTab === 'profile' && (
                                <>
                                    <div className="bg-gray-800/30 p-4 rounded-lg border border-gray-800">
                                        <h3 className="text-sm font-semibold text-blue-400 mb-4 flex items-center gap-2">
                                            <Calculator size={16}/> Calculate BMR
                                        </h3>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-400 mb-1">Gender</label>
                                                <select value={userSettings.gender} onChange={(e) => setUserSettings({...userSettings, gender: e.target.value})} className="w-full bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                                    <option value="male">Male</option>
                                                    <option value="female">Female</option>
                                                </select>
                                            </div>
                                            <div><label className="block text-xs font-medium text-gray-400 mb-1">Age</label><input type="number" value={userSettings.age} onChange={(e) => setUserSettings({...userSettings, age: e.target.value})} className="w-full bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-sm outline-none" /></div>
                                            <div><label className="block text-xs font-medium text-gray-400 mb-1">Weight (kg)</label><input type="number" value={userSettings.weight} onChange={(e) => setUserSettings({...userSettings, weight: e.target.value})} className="w-full bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-sm outline-none" /></div>
                                            <div><label className="block text-xs font-medium text-gray-400 mb-1">Height (cm)</label><input type="number" value={userSettings.height} onChange={(e) => setUserSettings({...userSettings, height: e.target.value})} className="w-full bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-sm outline-none" /></div>
                                        </div>
                                        <button onClick={onCalculateBMR} className="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md text-sm font-medium transition-colors">Calculate & Update BMR</button>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-400 mb-1">BMR (Calories/Day)</label>
                                        <div className="flex gap-2">
                                            <input type="number" value={userSettings.bmr} onChange={(e) => setUserSettings({...userSettings, bmr: Number(e.target.value)})} className="flex-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2 outline-none font-mono text-lg text-orange-400" />
                                            <div className="px-3 py-2 bg-gray-800 rounded-md text-sm text-gray-400 flex items-center">cal</div>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'cloud' && (
                                <div className="space-y-6">
                                    {/* 1. CONFIG */}
                                    <div className={`p-4 rounded-lg border ${firebaseConfig ? 'border-green-900/50 bg-green-900/10' : 'border-gray-800 bg-gray-800/30'}`}>
                                        <h3 className="text-sm font-bold text-white mb-2">1. Firebase Configuration</h3>
                                        
                                        {isPreconfigured ? (
                                             <div className="flex justify-between items-center bg-gray-950/50 p-3 rounded">
                                                <span className="text-xs text-green-400 flex items-center gap-2"><Icon size={14}><path d="M20 6L9 17l-5-5"/></Icon> Pre-Configured by Developer</span>
                                            </div>
                                        ) : (
                                            <>
                                                <p className="text-xs text-gray-400 mb-3">Paste your project's JSON config here.</p>
                                                {!firebaseConfig ? (
                                                    <>
                                                        <textarea 
                                                            value={configInput} 
                                                            onChange={(e) => setConfigInput(e.target.value)}
                                                            placeholder='{"apiKey": "...", "authDomain": "..."}'
                                                            className="w-full h-24 bg-gray-950 border border-gray-700 rounded-md p-2 text-xs font-mono text-gray-300 mb-2"
                                                        />
                                                        <button onClick={() => onSaveConfig(configInput)} className="w-full py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">Save Config</button>
                                                    </>
                                                ) : (
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-xs text-green-400 flex items-center gap-1"><Icon size={12}><path d="M20 6L9 17l-5-5"/></Icon> Config Loaded</span>
                                                        <button onClick={() => setFirebaseConfig(null)} className="text-xs text-red-400 hover:underline">Reset</button>
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>

                                    {/* 2. AUTH */}
                                    {firebaseConfig && (
                                        <div className={`p-4 rounded-lg border ${currentUser ? 'border-green-900/50 bg-green-900/10' : 'border-gray-800 bg-gray-800/30'}`}>
                                            <h3 className="text-sm font-bold text-white mb-2">2. Identity</h3>
                                            {!currentUser ? (
                                                <div className="space-y-4">
                                                    {/* Google Sign In */}
                                                    <button onClick={onGoogleLogin} className="w-full py-2 bg-white text-gray-900 text-sm font-medium rounded flex items-center justify-center gap-2 hover:bg-gray-100 transition-colors">
                                                        <GoogleIcon /> Sign in with Google
                                                    </button>
                                                    
                                                    <div className="relative">
                                                        <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-700"></div></div>
                                                        <div className="relative flex justify-center text-xs"><span className="px-2 bg-gray-900 text-gray-500">Or continue with email</span></div>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm"/>
                                                        <input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm"/>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => onLogin(email, password, false)} className="flex-1 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded">Log In</button>
                                                            <button onClick={() => onLogin(email, password, true)} className="flex-1 py-1.5 bg-gray-800 hover:bg-gray-700 text-white text-sm rounded border border-gray-700">Sign Up</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center">
                                                    <div className="text-xs">
                                                        <div className="text-gray-400">Logged in as</div>
                                                        <div className="text-white font-mono">{currentUser.email}</div>
                                                    </div>
                                                    <button onClick={onLogout} className="text-xs bg-red-900/30 text-red-400 px-2 py-1 rounded border border-red-900/50">Log Out</button>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* 3. ENCRYPTION */}
                                    {currentUser && (
                                        <div className={`p-4 rounded-lg border ${syncStatus === 'active' || syncStatus === 'success' ? 'border-green-900/50 bg-green-900/10' : 'border-blue-900/50 bg-blue-900/10'}`}>
                                            <h3 className="text-sm font-bold text-white mb-2 flex items-center gap-2"><Lock size={14}/> 3. Encryption</h3>
                                            <p className="text-xs text-gray-300 mb-3">
                                                Zero-Knowledge Sync. Your data is encrypted locally with this passphrase before being sent to the cloud.
                                            </p>
                                            
                                            {syncStatus === 'locked' || syncStatus === 'idle' ? (
                                                <div className="flex gap-2">
                                                    <input 
                                                        type="password" 
                                                        placeholder="Enter Sync Passphrase" 
                                                        value={syncPassphrase}
                                                        onChange={(e) => setSyncPassphrase(e.target.value)}
                                                        className="flex-1 bg-gray-950 border border-gray-700 rounded p-2 text-sm"
                                                    />
                                                    <button onClick={onUnlock} className="px-4 py-1.5 bg-blue-600 text-white text-sm rounded">Unlock/Sync</button>
                                                </div>
                                            ) : (
                                                <div className="text-xs text-green-400 flex items-center gap-2">
                                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                                    Encryption Active & Synced
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- DAY MODAL ---
        function DayModal({ dateKey, data, onClose, onUpdate, bmr }) {
            const foods = data?.foods || [];
            const exercises = data?.exercises || [];
            const updateList = (list, id, field, val) => list.map(item => item.id === id ? { ...item, [field]: val } : item);
            
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 flex items-center justify-center p-2 md:p-6 overflow-hidden">
                    <div className="bg-gray-900 border border-gray-800 rounded-xl shadow-2xl w-full max-w-4xl h-full md:h-auto md:max-h-[90vh] flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-200">
                        <div className="flex justify-between items-center p-6 border-b border-gray-800">
                            <div><h2 className="text-2xl font-bold text-white">{formatDisplayDate(dateKey)}</h2></div>
                            <button onClick={onClose}><X size={24} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-8">
                            <section>
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-semibold text-emerald-400 flex items-center gap-2"><Utensils size={20}/> Food</h3><button onClick={() => onUpdate('foods', [...foods, { id: generateId(), name: '', calories: '', protein: '' }])} className="text-xs bg-emerald-900/30 text-emerald-400 px-2 py-1 rounded border border-emerald-900/50"><Plus size={14}/> Add</button></div>
                                <div className="bg-gray-950/50 rounded-lg border border-gray-800 overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-gray-800/50 text-gray-400"><tr><th className="p-3 w-1/2">Item</th><th className="p-3">Cal</th><th className="p-3">Prot(g)</th><th className="p-3"></th></tr></thead>
                                        <tbody className="divide-y divide-gray-800">
                                            {foods.map(item => (
                                                <tr key={item.id}>
                                                    <td className="p-2"><input type="text" value={item.name} onChange={e => onUpdate('foods', updateList(foods, item.id, 'name', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="Item Name"/></td>
                                                    <td className="p-2"><input type="number" value={item.calories} onChange={e => onUpdate('foods', updateList(foods, item.id, 'calories', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="0"/></td>
                                                    <td className="p-2"><input type="number" value={item.protein} onChange={e => onUpdate('foods', updateList(foods, item.id, 'protein', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="0"/></td>
                                                    <td className="p-2"><button onClick={() => onUpdate('foods', foods.filter(i => i.id !== item.id))}><Trash2 size={16} className="text-gray-600 hover:text-red-500"/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-semibold text-orange-400 flex items-center gap-2"><Dumbbell size={20}/> Exercise</h3><button onClick={() => onUpdate('exercises', [...exercises, { id: generateId(), type: 'strength', name: '', sets: '', reps: '', duration: '', calories: '' }])} className="text-xs bg-orange-900/30 text-orange-400 px-2 py-1 rounded border border-orange-900/50"><Plus size={14}/> Add</button></div>
                                <div className="bg-gray-950/50 rounded-lg border border-gray-800 overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-gray-800/50 text-gray-400"><tr><th className="p-3">Type</th><th className="p-3">Name</th><th className="p-3">Sets</th><th className="p-3">Reps</th><th className="p-3">Min</th><th className="p-3">Cal</th><th className="p-3"></th></tr></thead>
                                        <tbody className="divide-y divide-gray-800">
                                            {exercises.map(item => (
                                                <tr key={item.id}>
                                                    <td className="p-2"><select value={item.type} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'type', e.target.value))} className="bg-gray-900 border border-gray-700 rounded text-xs py-1"><option value="strength">Str</option><option value="cardio">Cardio</option><option value="warmup">Warm</option></select></td>
                                                    <td className="p-2"><input type="text" value={item.name} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'name', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="Name"/></td>
                                                    <td className="p-2"><input type="number" value={item.sets} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'sets', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="-"/></td>
                                                    <td className="p-2"><input type="number" value={item.reps} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'reps', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="-"/></td>
                                                    <td className="p-2"><input type="number" value={item.duration} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'duration', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="-"/></td>
                                                    <td className="p-2"><input type="number" value={item.calories} onChange={e => onUpdate('exercises', updateList(exercises, item.id, 'calories', e.target.value))} className="w-full bg-transparent outline-none text-gray-200" placeholder="0"/></td>
                                                    <td className="p-2"><button onClick={() => onUpdate('exercises', exercises.filter(i => i.id !== item.id))}><Trash2 size={16} className="text-gray-600 hover:text-red-500"/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
